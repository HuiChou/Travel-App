<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Travel App</title>
  <link rel="icon" type="image/png" href="./favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Old+Mincho:wght@400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- NEW: Add SheetJS (xlsx) for Excel export and import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { serif: ['"Zen Old Mincho"', 'serif'], sans: ['"Noto Sans TC"', 'sans-serif'] },
          colors: { paper: '#F9F7F2', gold: 'var(--theme-color)', ink: '#333333', sub: '#8C8C8C' },
          // ç§»é™¤èˆŠçš„ animation keyframesï¼Œæˆ‘å€‘å°‡ä½¿ç”¨æ–°çš„ CSS é¡åˆ¥å’Œè‡ªå®šç¾©å±¬æ€§
          animation: { 
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both' // æ–°å¢å½ˆè·³é€²å ´å‹•ç•«
          },
          keyframes: { 
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            bounceIn: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } } 
          }
        }
      }
    }
  </script>

  <style>
    :root { 
      --theme-color: #C6A664; 
      --spring-curve: cubic-bezier(0.34, 1.56, 0.64, 1); /* æ ¸å¿ƒç‰©ç†å½ˆç°§æ›²ç·š */
      --smooth-curve: cubic-bezier(0.16, 1, 0.3, 1);    /* çµ²æ»‘ç·©å…¥æ›²ç·š */
      --travel-bg-color: #F9F7F2; /* è«è˜­è¿ªæ·ºè‰² (ç”± JS è¨­ç½®) */
    }
    html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
    body { background-color: #F9F7F2; color: #333; font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .smooth-scroll-container { overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; }
    .smooth-scroll-item { scroll-snap-align: start; }
    
    /* æ ¸å¿ƒ: è¼¸å…¥æ¡†å’Œä¸‹æ‹‰é¸å–®çš„çµ²æ»‘è½‰å ´ */
    input, textarea, select { 
      background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.1); border-radius: 0; padding: 4px 0; 
      transition: border-color 0.4s var(--smooth-curve); /* æå‡è½‰å ´é€Ÿåº¦å’Œæ›²ç·š */
      font-family: 'Zen Old Mincho', serif; 
    }
    input:focus, textarea:focus, select:focus { outline: none; border-bottom-color: var(--theme-color); }
    
    /* æ ¸å¿ƒ: æµ®å‹•æŒ‰éˆ•çš„ç‰©ç†å½ˆç°§æ•ˆæœ */
    .float-btn { 
      width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255,255,255,0.15); backdrop-filter: blur(8px); 
      border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; 
      transition: all 0.3s var(--spring-curve); /* ä½¿ç”¨å½ˆç°§æ›²ç·š */
      z-index: 50; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    }
    .float-btn:hover { background-color: rgba(255,255,255,0.3); transform: translateY(-2px) scale(1.05); } /* å¢åŠ ç¸®æ”¾æ„Ÿ */
    .float-btn:active { transform: translateY(0px) scale(0.95); transition: all 0.1s linear; } /* é»æ“Šæ™‚å¿«é€Ÿæ”¶ç¸® */
    .float-btn-danger:hover { background-color: #ef4444; border-color: #ef4444; }
    .float-btn.active { background-color: var(--theme-color); border-color: var(--theme-color); color: white; box-shadow: 0 0 15px var(--theme-color); transform: scale(1.05); }

    /* æ ¸å¿ƒ: è† å›ŠæŒ‰éˆ•çš„ç‰©ç†å½ˆç°§æ•ˆæœ */
    .capsule-btn { 
      padding: 6px 16px; background-color: white; border: 1px solid #E5E7EB; border-radius: 9999px; font-size: 12px; 
      color: #6B7280; 
      transition: all 0.3s var(--spring-curve); /* ä½¿ç”¨å½ˆç°§æ›²ç·š */
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 4px; 
    }
    .capsule-btn:hover { color: var(--theme-color); border-color: var(--theme-color); transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .capsule-btn:active { transform: translateY(0px) scale(0.98); transition: all 0.1s linear; }

    /* æ ¸å¿ƒ: ä¸»è¦è¡Œå‹•æŒ‰éˆ•çš„ç‰©ç†å½ˆç°§æ•ˆæœ */
    .btn-primary { 
      background-color: var(--theme-color); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; font-size: 14px; 
      box-shadow: 0 4px 12px rgba(198, 166, 100, 0.3); 
      transition: all 0.3s var(--spring-curve); /* ä½¿ç”¨å½ˆç°§æ›²ç·š */
      display: flex; align-items: center; gap: 8px; 
    }
    .btn-primary:hover { filter: brightness(1.1); transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 16px rgba(198, 166, 100, 0.5); }
    .btn-primary:active { transform: translateY(0px) scale(0.98); transition: all 0.1s linear; }

    /* æ–°å¢ç¯€é»æŒ‰éˆ•çš„çµ²æ»‘æ•ˆæœ */
    .add-node-btn { 
      width: 100%; padding: 16px; background-color: rgba(255,255,255,0.6); border: 2px dashed #CBD5E1; border-radius: 16px; 
      color: #94A3B8; font-family: 'Zen Old Mincho', serif; font-size: 14px; 
      transition: all 0.3s var(--smooth-curve); 
      display: flex; align-items: center; justify-content: center; gap: 8px; 
    }
    .add-node-btn:hover { background-color: white; border-color: var(--theme-color); color: var(--theme-color); transform: translateY(-1px); }

    /* æ ¸å¿ƒ: æ—¥æœŸæ¨™ç±¤çš„å¹³æ»‘è½‰å ´ */
    .day-tab-active { 
      background-color: var(--theme-color); color: white; 
      box-shadow: 0 4px 12px rgba(198, 166, 100, 0.4); 
      transform: scale(1.05); 
      border: 2px solid white; 
      border-radius: 16px; 
      transition: all 0.4s var(--smooth-curve); /* ç¢ºä¿åˆ‡æ›æ™‚å¹³æ»‘ */
    }
    .day-tab-inactive { 
      background-color: white; color: #ccc; border: 1px solid #f3f4f6; border-radius: 16px;
      transition: all 0.4s var(--smooth-curve);
    }
    .day-tab-inactive:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    /* æ ¸å¿ƒ: å°èˆªåˆ—çš„çµ²æ»‘è½‰å ´ */
    .sticky-header {
        transition: all 0.4s var(--smooth-curve);
    }

    /* æ ¸å¿ƒ: æ™‚é–“è»¸å¡ç‰‡çš„æ»¾å‹•æ¼¸å…¥å‹•ç•« (é è¨­ç‹€æ…‹) */
    .timeline-card {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.6s var(--smooth-curve), transform 0.6s var(--smooth-curve), background-color 0.3s; /* åŠ å…¥èƒŒæ™¯è‰²è½‰å ´ */
        /* è‡ªå®šç¾©å»¶é²å°‡ç”± JS æ³¨å…¥ */
    }
    /* æ¿€æ´»ç‹€æ…‹ */
    .timeline-card.in-view {
        opacity: 1;
        transform: translateY(0);
    }

    /* äº¤é€šå°å¡æ¨£å¼ (å·²åˆªé™¤ï¼Œä½†ä¿ç•™é¡åä»¥é˜²è¬ä¸€ï¼Œä½†ç„¡å…§å®¹) */
    .timeline-travel-card {
        /* ä½¿å°å¡ç‰‡ä½æ–¼æ™‚é–“è»¸ä¸­å¿ƒç·š */
        margin-left: 20px; 
        position: relative;
    }
    .timeline-travel-card .absolute {
        /* ç¢ºä¿çµ•å°å®šä½å…ƒç´ ä¸æœƒè¢« timeline-card çš„ transform å½±éŸ¿ */
        transform: none !important; 
    }
    
    /* æ ¸å¿ƒ: å…¶ä»–å¡ç‰‡å’Œåˆ—è¡¨é …ç›®çš„çµ²æ»‘è½‰å ´ */
    .drag-item {
        transition: all 0.3s var(--smooth-curve); /* è®“æ‹–æ›³æ™‚çš„ç‹€æ…‹åˆ‡æ›æ›´å¹³æ»‘ */
    }
    .group:hover .drag-item {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .group:hover .card-actions { 
        opacity: 1; 
        transition: opacity 0.3s var(--smooth-curve);
    }
    /* ... ä¿ç•™å…¶ä»–ä¸è®Šçš„ CSS ... */


    .custom-checkbox { appearance: none; width: 20px; height: 20px; border: 2px solid var(--theme-color); border-radius: 6px; cursor: pointer; display: grid; place-content: center; flex-shrink: 0; }
    .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em var(--theme-color); transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
    .custom-checkbox:checked::before { transform: scale(1); }
    
    .sub-tab-active { background-color: white; color: var(--theme-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-weight: bold; transition: all 0.3s var(--smooth-curve); }
    .sub-tab-inactive { color: #9CA3AF; transition: all 0.3s var(--smooth-curve); }
    .sub-tab-inactive:hover { color: #4B5563; }

    /* Expense Panel - Original Drawer Style */
    .expense-panel-responsive { transition: all 0.5s var(--smooth-curve); overflow: hidden; flex-shrink: 0; background-color: rgba(249, 250, 251, 0.5); width: 100%; max-height: 0; border-top: 0px solid #e5e5e5; opacity: 0; }
    .expense-panel-responsive.open { max-height: 2000px; border-top-width: 1px; opacity: 1; padding-bottom: 16px; }
    @media (min-width: 768px) {
        .expense-panel-responsive { width: 0; max-height: none !important; height: auto; border-top: none; border-left: 0px solid #e5e5e5; border-left-style: dashed; opacity: 1; padding-bottom: 0; }
        .expense-panel-responsive.open { width: 340px; border-left-width: 2px; }
    }
    
    .avatar-circle { border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    
    #edit-modal-overlay { 
      position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; 
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease; 
    }
    #edit-settings-modal.show #edit-modal-overlay { opacity: 1; visibility: visible; }

    .edit-modal-content { 
      background: white; width: 100%; max-width: 340px; border-radius: 24px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
      transform: scale(0.9); transition: transform 0.3s var(--spring-curve); 
    }
    #edit-settings-modal.show .edit-modal-content { transform: scale(1); }

    .edit-modal-input { color: #333; border-bottom: 1px solid #ddd; text-align: left; width: 100%; padding: 4px 0; }
    
    .nav-floating-btn { 
      position: absolute; left: 50%; bottom: 20px; transform: translateX(-50%); width: 72px; height: 72px; border-radius: 24px; 
      background-color: var(--theme-color); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); display: flex; flex-direction: column; 
      align-items: center; justify-content: center; z-index: 60; border: 4px solid #F9F7F2; 
      transition: transform 0.3s var(--spring-curve), background-color 0.3s; 
    }
    .nav-floating-btn:active { transform: translateX(-50%) scale(0.9); transition: transform 0.1s linear; }
    .nav-floating-btn.active { box-shadow: 0 10px 30px rgba(198, 166, 100, 0.6); } /* æ´»èºæ™‚å¢åŠ æ›´äº®çš„é™°å½± */
    
    .drag-item.dragging { opacity: 0.5; border: 2px dashed var(--theme-color); background: #fffbeb; }
    .drag-handle { cursor: grab; touch-action: none; }
    .drag-handle:active { cursor: grabbing; }
    
    /* æ ¸å¿ƒ: åœ–è¡¨ Legend è† å›Šçš„ç‰©ç†å½ˆç°§æ•ˆæœ */
    .legend-pill { 
      display: inline-flex; align-items: center; padding: 6px 14px; background: white; border: 1px solid #f3f4f6; border-radius: 20px; 
      font-size: 13px; font-weight: 700; color: #4b5563; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 4px; cursor: pointer; 
      transition: all 0.3s var(--spring-curve); /* ä½¿ç”¨å½ˆç°§æ›²ç·š */
      user-select: none; 
    }
    .legend-pill:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .legend-pill.inactive { opacity: 0.3; background: #f3f4f6; box-shadow: none; transform: scale(0.95); transition: all 0.3s ease-out; }
    .legend-pill.active { border-color: var(--theme-color); background-color: #fffbeb; transform: scale(1.0); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
    
    .input-label { font-size: 10px; color: #9ca3af; margin-bottom: 2px; display: block; }
    
    /* Toast çµ²æ»‘æ»‘å…¥/æ»‘å‡º */
    .toast-banner { transition: transform 0.4s var(--smooth-curve); }
    .toast-active { transform: translateY(0) !important; }

    /* Button visibility on card hover */
    .card-actions { opacity: 0; transition: opacity 0.3s var(--smooth-curve); }
    .group:hover .card-actions { opacity: 1; }
    @media (max-width: 768px) { .card-actions { opacity: 1; } }
    
    /* Toggle Switch Styles */
    .toggle-container { background: #f3f4f6; padding: 4px; border-radius: 99px; display: inline-flex; position: relative; cursor: pointer; }
    .toggle-btn { padding: 8px 16px; border-radius: 99px; font-size: 12px; font-weight: bold; z-index: 2; position: relative; transition: color 0.3s; width: 140px; text-align: center; }
    .toggle-btn.active { color: white; }
    .toggle-btn.inactive { color: #9ca3af; }
    .toggle-slider { 
      position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background-color: var(--theme-color); 
      border-radius: 99px; 
      transition: transform 0.4s var(--smooth-curve); /* ä½¿ç”¨çµ²æ»‘æ›²ç·š */
      z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    
    /* Settlement Card */
    .settlement-card { background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%); border: 1px solid #fcd34d; }
    
    /* --- çµå¸³æ¸…å–®å°ˆç”¨æ¨£å¼ (è† å›Š+é•·ç®­é ­) --- */
    .info-pill {
      display: flex; align-items: center; background-color: #fff; border: 1px solid #e2e8f0; border-radius: 50px; padding: 4px; padding-right: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); height: 40px; min-width: 90px; flex-shrink: 0;
      transition: all 0.3s var(--spring-curve); /* åŠ å…¥å½ˆç°§ */
    }
    .info-pill:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    .circle-avatar-new { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px; margin-right: 8px; flex-shrink: 0; }
    .pill-text { font-size: 14px; font-weight: 700; color: #475569; white-space: nowrap; }
    .transfer-middle { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 0 8px; }
    .action-label-settlement { font-size: 11px; color: #F97316; font-weight: 700; margin-bottom: -4px; letter-spacing: 0.5px; }
    .long-arrow-settlement { width: 100%; max-width: 60px; height: 24px; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; transition: transform 0.3s var(--smooth-curve); }
    
    .traveler-select { display: flex; align-items: center; width: 100%; position: relative; border-bottom: 1px solid #ddd; transition: border-color 0.4s var(--smooth-curve); }
    .traveler-select:focus-within { border-bottom-color: var(--theme-color); }
    .traveler-select select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background: transparent; border: none; padding: 4px 0; padding-right: 20px; font-size: 14px; font-weight: 700; color: #475569; cursor: pointer; z-index: 2; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; }
    .traveler-select .select-display { display: flex; align-items: center; flex: 1; min-height: 30px; z-index: 1; pointer-events: none; }
    .traveler-select .select-display .name { font-size: 14px; font-weight: 700; color: #475569; margin-left: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .traveler-select .select-display .arrow { position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; color: #9ca3af; pointer-events: none; }
    
    #current-date-text { min-width: 80px; display: inline-block; white-space: nowrap; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="pb-28">

  <div id="pdf-temp-container" class="fixed top-0 left-[-9999px] bg-white p-10 w-[210mm] min-h-[297mm] font-serif text-ink"></div>
  <div id="message-banner" class="toast-banner fixed top-0 left-0 right-0 py-3 text-center text-white z-[9999] transition-transform duration-300 transform -translate-y-full shadow-md font-serif tracking-widest bg-[var(--theme-color)] text-sm"></div>

  <div id="edit-settings-modal" class="hidden">
      <div id="edit-modal-overlay" onclick="toggleSettings()">
          <div class="edit-modal-content" onclick="event.stopPropagation()">
              <h3 class="text-lg font-bold text-[var(--theme-color)] mb-4 text-center font-serif">æ—…ç¨‹è¨­å®š</h3>
              <div class="flex flex-col gap-4">
                  <div><label class="text-xs text-gray-400 block mb-1">æ—…ç¨‹æ¨™é¡Œ</label><input type="text" id="edit-theme" class="edit-modal-input text-xl font-bold font-serif"></div>
                  <div class="flex gap-3"><div class="flex-1"><label class="text-xs text-gray-400 block mb-1">é–‹å§‹</label><input type="date" id="edit-start-date" class="edit-modal-input text-sm"></div><div class="flex-1"><label class="text-xs text-gray-400 block mb-1">çµæŸ</label><input type="date" id="edit-end-date" class="edit-modal-input text-sm"></div></div>
                  
                  <!-- MODIFIED: Add file upload capability -->
                  <div>
                    <label class="text-xs text-gray-400 block mb-1">å°é¢åœ–ç‰‡ä¾†æº</label>
                    <div class="flex flex-col gap-2 p-3 border border-gray-100 rounded-lg bg-gray-50">
                        <!-- UPDATED UI TEXT (5MB Limit) -->
                        <label for="banner-file-input" class="text-xs font-bold text-[var(--theme-color)]">1. ä¸Šå‚³æœ¬æ©Ÿæª”æ¡ˆ (å»ºè­° < 5MB)</label>
                        <input type="file" id="banner-file-input" accept="image/*" onchange="handleBannerUpload(event)" class="text-sm w-full text-gray-700">
                        <label class="text-xs font-bold text-[var(--theme-color)] mt-2">2. æˆ–è²¼ä¸Šç¶²è·¯ç¶²å€</label>
                        <!-- Hidden input field to store the URL/Base64 -->
                        <input type="text" id="edit-banner-url" class="edit-modal-input text-xs font-sans text-blue-500 bg-white" placeholder="https://images.unsplash.com/..." oninput="updateBannerPreview(this.value)">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">ä¸Šå‚³åœ–ç‰‡å°‡è½‰æ›ç‚º Base64 å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œå¯èƒ½æœƒä½”ç”¨è¼ƒå¤šå„²å­˜ç©ºé–“ã€‚è‹¥è¼‰å…¥å¤±æ•—è«‹å˜—è©¦å£“ç¸®åœ–ç‰‡ã€‚</p>
                  </div>
                  
                  <div class="flex gap-3 items-center">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">å¤–å¹£å¹£åˆ¥</label>
                        <select id="edit-currency-code" class="edit-modal-input text-sm w-full font-bold">
                            <option value="JPY">ğŸ‡¯ğŸ‡µ JPY æ—¥å¹£</option>
                            <option value="KRW">ğŸ‡°ğŸ‡· KRW éŸ“å…ƒ</option>
                            <option value="USD">ğŸ‡ºğŸ‡¸ USD ç¾é‡‘</option>
                            <option value="THB">ğŸ‡¹ğŸ‡­ THB æ³°éŠ–</option>
                            <option value="EUR">ğŸ‡ªğŸ‡º EUR æ­å…ƒ</option>
                            <option value="CNY">ğŸ‡¨ğŸ‡³ CNY äººæ°‘å¹£</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">åŒ¯ç‡</label>
                        <input type="number" step="0.0001" id="edit-rate" class="edit-modal-input text-sm w-full" placeholder="ä¾‹å¦‚ 0.21">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ä¸»é¡Œè‰²</label>
                        <input type="color" id="edit-color" class="h-8 w-8">
                    </div>
                  </div>

                  <div class="pt-2 border-t border-gray-100 bg-yellow-50 p-2 rounded-lg"><label class="text-xs font-bold text-[var(--theme-color)] block mb-2">æ—…ä¼´ç®¡ç† (é€—è™Ÿåˆ†éš”)</label><input type="text" id="edit-travelers" class="edit-modal-input text-sm" placeholder="ä¾‹å¦‚: æˆ‘, ç”·å‹, å…¬è²»"><p class="text-[10px] text-gray-400 mt-1">å„²å­˜å¾Œï¼Œè¨˜å¸³æ¬„ä½è‡ªå‹•æ›´æ–°</p></div>
                  <button onclick="saveAndCloseSettings()" class="mt-2 w-full py-3 bg-[var(--theme-color)] text-white rounded-xl font-bold shadow-lg hover:opacity-90 transition">å®Œæˆä¸¦å„²å­˜</button>
              </div>
          </div>
      </div>
  </div>

  <div id="screen-project-list" class="min-h-screen px-6 py-10 flex flex-col items-center bg-[#53565C]">
      <h1 class="text-3xl font-serif font-bold text-white mb-2 tracking-widest animate-fade-in" style="animation-delay: 0.1s;">æˆ‘çš„æ—…ç¨‹</h1>
      <p class="text-xs text-gray-300 mb-8 font-sans tracking-wider animate-fade-in" style="animation-delay: 0.2s;">SELECT YOUR JOURNEY</p>
      <div id="project-list-container" class="w-full max-w-md space-y-4"></div>
      <button onclick="createNewProject()" class="mt-8 px-6 py-3 bg-white text-[#53565C] rounded-xl font-bold text-sm shadow-lg hover:bg-gray-100 transition flex items-center gap-2 animate-bounce-in" style="animation-delay: 0.5s;"><span>ï¼‹ è¦åŠƒæ–°æ—…ç¨‹</span></button>
  </div>

  <div id="screen-itinerary" class="hidden transition-opacity duration-500">
      <!-- MODIFIED: Added ID and placeholder for robust image handling -->
      <header id="hero-header" class="relative h-[180px] w-full overflow-hidden group bg-gray-300">
        <div id="hero-placeholder" class="absolute inset-0 z-10 flex items-center justify-center text-white/50 text-xs font-sans font-bold">è¼‰å…¥å°é¢åœ–ç‰‡ä¸­...</div>
        <div class="absolute inset-0 bg-black/30 z-20"></div>
        <!-- MODIFIED: Added onerror/onload handlers and initial opacity: 0 -->
        <img id="hero-image" src="" onerror="handleImageError()" onload="handleImageLoad()" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105 opacity-0" alt="Cover">
        <div class="absolute inset-0 z-30 flex flex-col justify-center items-center text-white pt-4 px-6" id="header-content"></div>
        <div class="absolute top-3 right-3 md:top-4 md:right-4 flex flex-row gap-2 md:gap-3 z-50 scale-90 md:scale-100 origin-top-right">
            
            <!-- MODIFIED: Change CSV export to Excel export -->
            <button onclick="exportAllToExcel()" class="float-btn" title="åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ç‚º Excel (.xlsx)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5A2.25 2.25 0 005.25 15h13.5A2.25 2.25 0 0021 13.5V5.25A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25v8.25zm6 0h.008v.008H9v-.008zM12 13.5h.008v.008H12v-.008zM15 13.5h.008v.008H15v-.008zM18 13.5h.008v.008H18v-.008z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 18.75V15h18v3.75A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75zm6 0h.008v.008H9v-.008zM12 18.75h.008v.008H12v-.008zM15 18.75h.008v.008H15v-.008zM18 18.75h.008v.008H18v-.008z" />
                </svg>
            </button>
            
            <!-- MODIFIED: Changed ID and accept to support Excel import -->
            <label for="import-excel-file" class="float-btn cursor-pointer" title="åŒ¯å…¥å®Œæ•´è¡Œç¨‹ Excel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5A3.375 3.375 0 0010.125 2.25H5.625A2.25 2.25 0 003.375 4.5v15A2.25 2.25 0 005.625 21h12.75a2.25 2.25 0 002.25-2.25V15.5M12 9l-4.5 4.5M12 9l4.5 4.5M12 9V21" />
                </svg>
            </label>
            <!-- UPDATED: Pointed to new Excel import function -->
            <input type="file" id="import-excel-file" accept=".xlsx" class="hidden" onchange="importActivitiesFromExcel(event)">
            
            <button onclick="exportAllPdf()" class="float-btn" title="è¼¸å‡º PDF">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
            </button>
            
            <button onclick="toggleSettings()" class="float-btn" title="è¨­å®š"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
            <button onclick="toggleContentEdit()" id="edit-content-btn" class="float-btn" title="ç·¨è¼¯è¡Œç¨‹"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" /></svg></button>
            
            <button onclick="resetAllData()" class="float-btn float-btn-danger" title="é‡ç½®ç‰ˆé¢ (æ¸…ç©ºæ‰€æœ‰è³‡æ–™)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
        </div>
      </header>

      <div class="sticky top-0 z-40 bg-paper/95 backdrop-blur-sm border-b border-gray-200/50 py-2 shadow-sm sticky-header">
        <div class="flex items-center justify-between w-full px-4 md:px-8 h-[70px]">
            <div id="day-scroll-container" class="smooth-scroll-container flex items-center overflow-x-auto no-scrollbar gap-3 flex-1 min-w-0"></div>
            </div>
      </div>

      <main class="px-5 py-6 max-w-2xl mx-auto min-h-[60vh] relative">
        <div class="mb-6 animate-fade-in" style="animation-delay: 0.2s;">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <h2 id="current-day-heading" class="text-3xl md:text-4xl font-serif font-black text-ink tracking-tight whitespace-nowrap">Day 1</h2>
                    
                    <div class="flex items-center gap-3 bg-white/80 backdrop-blur px-3 py-1.5 rounded-2xl border border-gray-200/60 shadow-sm hover:shadow-md transition-all cursor-pointer select-none">
                        <div id="travelers-breakdown" class="flex items-center gap-1 overflow-x-auto no-scrollbar"></div>
                        
                        <div class="flex flex-col items-end min-w-[100px]" onclick="switchTab('chart')">
                            <p class="text-[9px] text-gray-400 font-sans tracking-wider uppercase mb-0.5">TOTAL</p>
                            <p class="text-lg font-serif font-bold text-[var(--theme-color)] leading-none whitespace-nowrap" id="header-total-base">Â¥ 0</p>
                            <p class="text-[10px] text-gray-400 leading-none mt-0.5 whitespace-nowrap" id="header-total-target">â‰ˆ NT$ 0</p>
                        </div>
                    </div>
                </div>

                <div id="template-actions" class="hidden flex gap-2">
                    <button onclick="applyDayTemplate('departure')" class="capsule-btn"><span>ğŸ </span> å‡ºç™¼</button>
                    <button onclick="applyDayTemplate('general')" class="capsule-btn"><span>ğŸ“</span> è§€å…‰</button>
                    <button onclick="applyDayTemplate('return')" class="capsule-btn"><span>âœˆï¸</span> å›ç¨‹</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2 mt-1 ml-1">
                <span id="current-date-text" class="text-xs text-sub font-sans tracking-wide">--</span>
                <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                <span id="current-location-text" class="text-xs text-[var(--theme-color)] font-bold uppercase tracking-widest font-sans">LOCATION</span>
            </div>
            <div id="quick-add-act-btn" class="mt-4"> 
                <button onclick="addActivity()" class="capsule-btn bg-white border-[var(--theme-color)] text-[var(--theme-color)] hover:bg-gray-50 shadow-md">
                    <span>ï¼‹</span> æ–°å¢æ´»å‹•ç¯€é»
                </button>
            </div>
        </div>

        <div class="relative pl-4 pb-20">
          <div class="timeline-line"></div>
          <div id="timeline-container" class="space-y-6"></div>
          <div id="add-act-btn" class="hidden mt-8 ml-8 animate-fade-in"><button onclick="addActivity()" class="add-node-btn"><span>ï¼‹</span> æ–°å¢è¡Œç¨‹ç¯€é»</button></div>
        </div>
      </main>
  </div>

  <div id="screen-lists" class="hidden min-h-screen px-6 py-10 max-w-lg mx-auto">
      <h1 class="text-3xl font-serif font-bold text-[var(--theme-color)] mb-2 text-center animate-fade-in" style="animation-delay: 0.1s;">æ¸…å–®ç®¡ç†</h1>
      <p class="text-xs text-sub mb-6 font-sans text-center tracking-widest animate-fade-in" style="animation-delay: 0.2s;">LISTS & SHOPPING</p>
      
      <div class="flex p-1 bg-gray-100 rounded-xl mx-auto max-w-xs mb-8 shadow-inner relative animate-fade-in" style="animation-delay: 0.3s;">
          <div id="sub-tab-checklist" class="w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-active text-sm" onclick="switchListSubTab('checklist')">ğŸ§³ è¡Œææº–å‚™</div>
          <div id="sub-tab-shopping" class="w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-inactive text-sm" onclick="switchListSubTab('shopping')">ğŸ›ï¸ è³¼ç‰©é¡˜æœ›</div>
      </div>

      <div id="container-checklist">
          <div class="flex flex-col gap-4 mb-6 border-b border-gray-100 pb-6">
              <div class="flex gap-2 w-full"><input type="text" id="new-item-input" placeholder="æ–°å¢è¡Œæé …ç›®..." class="flex-1 bg-white px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-[var(--theme-color)] shadow-sm"><button onclick="addChecklistItem()" class="bg-[var(--theme-color)] text-white w-12 rounded-xl text-lg shadow hover:opacity-90 transition">ï¼‹</button></div>
              <div class="flex gap-2 overflow-x-auto no-scrollbar pt-1">
                  <button onclick="applyChecklist(2)" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-xs hover:border-[var(--theme-color)] hover:text-[var(--theme-color)] transition whitespace-nowrap">2 Days</button>
                  <button onclick="applyChecklist(3)" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-xs hover:border-[var(--theme-color)] hover:text-[var(--theme-color)] transition whitespace-nowrap">3 Days</button>
                  <button onclick="applyChecklist(5)" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-xs hover:border-[var(--theme-color)] hover:text-[var(--theme-color)] transition whitespace-nowrap">5 Days</button>
                  <button onclick="applyChecklist(8)" class="px-3 py-1 bg-white border border-gray-200 rounded-lg text-xs hover:border-[var(--theme-color)] hover:text-[var(--theme-color)] transition whitespace-nowrap">8 Days</button>
              </div>
          </div>
          <div id="checklist-items" class="space-y-3 pb-24"></div>
      </div>

      <div id="container-shopping" class="hidden">
          <div class="flex flex-col gap-4 mb-6 border-b border-gray-100 pb-6">
              <div class="flex gap-2 w-full">
                  <input type="text" id="new-shop-input" placeholder="æ–°å¢æƒ³è²·çš„æ±è¥¿..." class="flex-1 bg-white px-4 py-3 rounded-xl border border-gray-200 text-sm focus:border-[var(--theme-color)] shadow-sm">
                  <button onclick="addShoppingItem()" class="bg-[var(--theme-color)] text-white w-12 rounded-xl text-lg shadow hover:opacity-90 transition">ï¼‹</button>
              </div>
          </div>
          <div id="shopping-items" class="space-y-3 pb-24"></div>
      </div>
  </div>

  <div id="screen-expenses" class="hidden min-h-screen px-6 py-10 max-w-4xl mx-auto">
      <h1 class="text-3xl font-serif font-bold text-[var(--theme-color)] mb-2 animate-fade-in" style="animation-delay: 0.1s;">è²»ç”¨åˆ—è¡¨</h1>
      <p class="text-xs text-sub mb-6 font-sans animate-fade-in" style="animation-delay: 0.2s;">EXPENSES RECORD</p>
      
      <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6 animate-bounce-in" id="expense-form-container" style="animation-delay: 0.3s;">
          <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                  <label class="input-label">æ—¥æœŸ</label>
                  <input type="date" id="exp-date" class="edit-modal-input text-sm w-full" required>
              </div>
              <div>
                  <label class="input-label">é¡åˆ¥</label>
                  <select id="exp-category" class="edit-modal-input text-sm font-bold w-full">
                      <option value="é£Ÿ">ğŸš é£Ÿ</option><option value="è¡£">ğŸ‘• è¡£</option><option value="ä½">ğŸ¨ ä½</option>
                      <option value="è¡Œ">ğŸš† è¡Œ</option><option value="è‚²">ğŸ« è‚²</option><option value="æ¨‚">ğŸ¡ æ¨‚</option>
                      <option value="è³¼">ğŸ›ï¸ è³¼</option><option value="é›œ">ğŸ”§ é›œ</option>
                  </select>
              </div>
          </div>
          <div class="mb-4">
              <label class="input-label">é …ç›®åç¨±</label>
              <input type="text" id="exp-name" placeholder="ä¾‹å¦‚: åˆé¤" class="edit-modal-input text-sm w-full">
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                  <label class="input-label">ä»˜æ¬¾äºº (èª°å‡ºçš„éŒ¢)</label>
                  <select id="exp-payer" class="edit-modal-input text-sm text-gray-600 w-full" onchange="syncBeneficiary(this.value)"></select>
              </div>
              <div>
                  <label class="input-label">å¹«èª°ä»˜ (å—ç›Šäºº)</label>
                  <select id="exp-beneficiary" class="edit-modal-input text-sm text-gray-600 w-full"></select>
              </div>
          </div>
          <div class="mb-4">
              <label class="input-label">ç´°é …å‚™è¨»</label>
              <input type="text" id="exp-detail" placeholder="ä¾‹å¦‚: æ‹‰éºµ" class="edit-modal-input text-xs w-full">
          </div>
          <div class="flex items-end gap-2 mb-4">
              <select id="exp-currency" class="text-sm font-bold border-b border-gray-200 pb-1 mr-1 text-gray-500" onchange="calcExpTWD(document.getElementById('exp-amount').value)"></select>
              <input type="number" inputmode="numeric" pattern="[0-9]*" id="exp-amount" placeholder="é‡‘é¡" class="flex-1 border-b border-gray-200 text-xl font-bold text-[var(--theme-color)] focus:outline-none pb-1" oninput="calcExpTWD(this.value)">
              <span class="text-xs text-gray-400 mb-1" id="exp-twd-preview">â‰ˆ NT$ 0</span>
          </div>
          <button onclick="addExpenseItem()" class="w-full py-3 bg-[var(--theme-color)] text-white rounded-xl font-bold shadow hover:opacity-90 transition">æ–°å¢è²»ç”¨</button>
      </div>

      <div id="expenses-list-container" class="space-y-3 pb-24"></div>
  </div>

  <div id="screen-chart" class="hidden min-h-screen px-6 py-10 max-w-4xl mx-auto flex flex-col">
      <h1 class="text-3xl font-serif font-bold text-[var(--theme-color)] mb-2 animate-fade-in" style="animation-delay: 0.1s;">èŠ±è²»çµ±è¨ˆ</h1>
      <p class="text-xs text-sub mb-6 font-sans animate-fade-in" style="animation-delay: 0.2s;">STATISTICS</p>
      
      <div class="flex justify-center mb-8 animate-fade-in" style="animation-delay: 0.3s;">
          <div class="toggle-container" onclick="toggleChartMode()">
              <div class="toggle-slider" id="chart-mode-slider"></div>
              <div class="toggle-btn active" id="btn-mode-payment">ğŸ’¸ çœŸå¯¦æ”¯ä»˜ (ç¾é‡‘)</div>
              <div class="toggle-btn inactive" id="btn-mode-consumption">ğŸ™‹ å€‹äººæ¶ˆè²» (æ­¸å±¬)</div>
          </div>
      </div>
      
      <div id="settlement-section" class="mb-8 w-full animate-bounce-in" style="animation-delay: 0.4s;">
          <div class="settlement-card rounded-2xl p-5 shadow-sm">
             <h3 class="text-sm font-bold text-ink mb-4 border-b border-[var(--theme-color)]/30 pb-2 flex items-center gap-2">
                 <span>ğŸ¤</span> çµå¸³åˆ†å¸³å»ºè­°
             </h3>
             <div id="settlement-list" class="space-y-3"></div>
          </div>
      </div>
      <div class="w-full space-y-8">
          <div class="flex flex-col md:flex-row gap-6 w-full items-start">
              <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 w-full md:w-7/12 aspect-square md:aspect-auto md:h-[400px] flex justify-center items-center"><canvas id="expenseChart"></canvas></div>
              <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 w-full md:w-5/12 h-fit"><h3 class="text-sm font-bold text-ink mb-4 border-b border-gray-100 pb-2" id="chart-pie-title">äººå“¡å…ˆä»˜æ˜ç´°</h3><div id="payer-breakdown-list" class="space-y-4"></div></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 w-full">
              <h3 class="text-sm font-bold text-ink mb-4 border-b border-gray-100 pb-2" id="chart-bar-title">æ¯äººå„é …é¡åˆ¥èŠ±è²»</h3>
              <div id="categoryChartLegend" class="flex flex-wrap gap-2 mb-4"></div>
              <div class="h-[300px] w-full"><canvas id="categoryChart"></canvas></div>
          </div>
          
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 w-full mb-24">
              <h3 class="text-sm font-bold text-ink mb-4 border-b border-gray-100 pb-2">é¡åˆ¥èŠ±è²»æ˜ç´°æ¸…å–®</h3>
              <div id="category-detail-list" class="space-y-6"></div>
          </div>
      </div>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 px-2 py-2 pb-safe z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] h-[60px]">
    <div class="relative w-full max-w-lg mx-auto h-full grid grid-cols-5 items-center">
      <button onclick="switchTab('list')" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-ink transition" id="nav-list"><svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path></svg><span class="text-[9px]">åˆ—è¡¨</span></button>
      <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-ink transition" id="nav-lists"><svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg><span class="text-[9px]">æ¸…å–®</span></button>
      <div class="relative h-full flex justify-center items-end pb-2">
          <button onclick="switchTab('itinerary')" class="nav-floating-btn" id="nav-itinerary-float"><svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg><span class="text-[10px] font-bold text-white mt-0.5">è¡Œç¨‹</span></button>
      </div>
      <button onclick="switchTab('expenses')" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-ink transition" id="nav-expenses"><svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-[9px]">è²»ç”¨</span></button>
      <button onclick="switchTab('chart')" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-ink transition" id="nav-chart"><svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg><span class="text-[9px]">çµ±è¨ˆ</span></button>
    </div>
  </nav>

  <script>
    let projects = [], currentProjectId = null, tripData = {}, currentDay = 1, isEditMode = false;
    let myChart = null;
    let categoryChart = null;
    let draggedExpenseIdx = null;
    let draggedActivityIdx = null; 
    let currentListTab = 'checklist';
    let activeCategoryFilter = null;
    let currentDisplayCurrency = 'JPY'; 
    let currentChartMode = 'payment'; // 'payment' (Real Payment/Cashflow) or 'consumption' (Beneficiary/Attribution)
    let observer = null; // Intersection Observer instance
    let isInitialLoad = true; // è¿½è¹¤æ˜¯å¦ç‚ºé é¢å‰›è¼‰å…¥

    const CURRENCY_SYMBOLS = { 'JPY': 'Â¥', 'KRW': 'â‚©', 'USD': '$', 'THB': 'à¸¿', 'EUR': 'â‚¬', 'CNY': 'Â¥' };
    let COLORS = ['#C6A664', '#E6DCC3', '#A88B4D', '#333333', '#8C8C8C', '#d1d5db', '#93c5fd', '#fca5a5'];
    const CAT_COLORS = { 'é£Ÿ': '#fca5a5', 'è¡£': '#fdba74', 'ä½': '#fcd34d', 'è¡Œ': '#86efac', 'è‚²': '#93c5fd', 'æ¨‚': '#c4b5fd', 'è³¼': '#f472b6', 'é›œ': '#94a3b8' };
    
    // UPDATED TEMPLATE STRUCTURE - ç§»é™¤ travel å±¬æ€§
    const TEMPLATES = {
        departure: [ 
            { time: "08:00", icon: "ğŸ ", label: "START", location: "ç”œèœœçš„å®¶", address:"", desc: "æª¢æŸ¥è­·ç…§", costType: "è¡Œ", expenseDetail: "è¨ˆç¨‹è»Š", currency: "TWD", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'TWD' }] }, 
            { time: "10:30", icon: "âœˆï¸", label: "FLIGHT", location: "æ©Ÿå ´ T1", address:"", desc: "è¾¦ç†ç™»æ©Ÿ", costType: "è¡Œ", currency: "TWD", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'TWD' }] } 
        ],
        general: [ 
            { time: "09:00", icon: "â˜•", label: "MORNING", location: "Blue Bottle", address:"äº¬éƒ½å¸‚å·¦äº¬å€å—ç¦ªå¯ºè‰å·ç”º64", desc: "æ™¨é–“å’–å•¡", costType: "é£Ÿ", expenseDetail: "æ‹¿éµ", currency: "JPY", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'JPY' }] }, 
            { time: "11:30", icon: "ğŸœ", label: "LUNCH", location: "éºµå±‹è±¬ä¸€", address:"äº¬éƒ½å¸‚ä¸‹äº¬å€æµç¾é ˆä¹‹ç”º542", desc: "å¿…æ¯”ç™»æ¨è–¦", costType: "é£Ÿ", expenseDetail: "æ‹‰éºµ", currency: "JPY", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'JPY' }] }, 
            { time: "15:00", icon: "â›©ï¸", label: "VISIT", location: "æ¸…æ°´å¯º", address:"äº¬éƒ½å¸‚æ±å±±å€æ¸…æ°´1ä¸ç›®294", desc: "ä¸–ç•Œéºç”¢", costType: "è‚²", expenseDetail: "é–€ç¥¨", currency: "JPY", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'JPY' }] } 
        ],
        return: [ 
            { time: "10:00", icon: "ğŸ", label: "BUY", location: "å…ç¨…åº—", address:"", desc: "æœ€å¾Œè¡åˆº", costType: "è³¼", expenseDetail: "ä¼´æ‰‹ç¦®", currency: "JPY", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'JPY' }] }, 
            { time: "16:00", icon: "ğŸ ", label: "HOME", location: "è¿”æŠµåœ‹é–€", address:"", desc: "å¹³å®‰å›å®¶", costType: "è¡Œ", expenseDetail: "æ©Ÿæ·", currency: "TWD", splits: [{ id: uuidv4(), beneficiary: 'è‡ªå·±', payer: 'è‡ªå·±', amount: 0, currency: 'TWD' }] } 
        ]
    };
    const CHECKLIST_PRESETS = { 2: ["èº«åˆ†è­‰/å¥ä¿å¡", "æ‰‹æ©Ÿ/å……é›»å™¨", "æ›æ´—è¡£ç‰©", "ç›¥æ´—ç”¨å“", "éŒ¢åŒ…"], 3: ["èº«åˆ†è­‰/å¥ä¿å¡", "æ‰‹æ©Ÿ/å……é›»å™¨", "è¡Œå‹•é›»æº", "æ›æ´—è¡£ç‰©", "ç›¥æ´—ç”¨å“", "éŒ¢åŒ…", "å¸¸å‚™è—¥å“"], 5: ["è­·ç…§/ç°½è­‰", "å¤–å¹£/ä¿¡ç”¨å¡", "ç¶²å¡", "æ‰‹æ©Ÿ/å……é›»å™¨", "è¡Œå‹•é›»æº", "è½‰æ¥é ­", "è¡£ç‰©", "ç›¥æ´—ç”¨å“", "è—¥å“", "é›¨å…·"], 8: ["è­·ç…§/ç°½è­‰", "å¤–å¹£", "ç¶²å¡", "æ‰‹æ©Ÿ/å……é›»å™¨", "è¡Œå‹•é›»æº", "è½‰æ¥é ­", "å»¶é•·ç·š", "è¶³å¤ è¡£ç‰©", "å¥½èµ°çš„é‹", "ç›¥æ´—/ä¿é¤Šå“", "è—¥å“", "é›¨å…·", "æŒ‡ç”²å‰ª"] };

    // æ–°å¢ UUID å‡½å¼ä»¥å‰µå»ºå‹•æ…‹åˆ†å¸³ ID
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ä¿®æ­£å¾Œçš„ç”¢ç”Ÿä¸»é¡Œè‰²ç³»å‡½æ•¸ï¼šæ¯ä½ä½¿ç”¨è€…æ¯”å‰ä¸€ä½æ·º 20%
    function generateThemePalette(baseHex, index, total) {
        let r = parseInt(baseHex.slice(1, 3), 16);
        let g = parseInt(baseHex.slice(3, 5), 16);
        let b = parseInt(baseHex.slice(5, 7), 16);
        if (index === 0) return baseHex; 
        const lightingStep = 0.6; 
        const factor = (index * lightingStep) % 0.8; 
        r = Math.round(r + (255 - r) * factor);
        g = Math.round(g + (255 - g) * factor);
        b = Math.round(b + (255 - b) * factor);
        const toHex = (c) => ('0' + c.toString(16)).slice(-2);
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    
    // NEW: ç”¢ç”Ÿè«è˜­è¿ªè‰²ï¼ˆä½é£½å’Œã€é«˜äº®åº¦ï¼‰
    function generateMorandiColor(hex) {
        if (!hex || hex.length !== 7) return '#F9F7F2';
        
        // 1. Convert HEX to RGB
        let r = parseInt(hex.substring(1, 3), 16) / 255;
        let g = parseInt(hex.substring(3, 5), 16) / 255;
        let b = parseInt(hex.substring(5, 7), 16) / 255;

        // 2. Convert RGB to HSL (Standard Algorithm)
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if (max === min) {
            h = s = 0; // achromatic
        } else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }

        // 3. Apply Morandi Transformation
        // é™ä½é£½å’Œåº¦åˆ° 30% (0.3) 
        // æé«˜äº®åº¦åˆ° 90% (0.9) - é€™æ˜¯ Morandi æŸ”å’Œæ„Ÿçš„é—œéµ
        let morandiS = 0.30; 
        let morandiL = 0.90; 
        
        s = morandiS; 
        l = morandiL;             

        // 4. Convert HSL back to RGB (Standard Algorithm)
        let R, G, B;

        if (s === 0) {
            R = G = B = l; // achromatic
        } else {
            const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1 / 6) return p + (q - p) * 6 * t;
                if (t < 1 / 2) return q;
                if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                return p;
            };
            let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            let p = 2 * l - q;
            R = hue2rgb(p, q, h + 1 / 3);
            G = hue2rgb(p, q, h);
            B = hue2rgb(p, q, h - 1 / 3);
        }

        // 5. Convert RGB to HEX
        const toHex = (c) => {
            let hexVal = Math.round(c * 255).toString(16);
            return hexVal.length === 1 ? "0" + hexVal : hexVal;
        };

        return `#${toHex(R)}${toHex(G)}${toHex(B)}`;
    }

    // --- æ–°å¢æ—…ä¼´ Select æ¸²æŸ“å·¥å…·å‡½å¼ ---
    function renderTravelerSelect(actIndex, splitId, selectedPerson, travelers, fieldName) {
        const id = `${fieldName}-${actIndex}-${splitId}`;
        let options = '';
        
        // 1. æ­£å¸¸æ—…ä¼´
        travelers.forEach(t => {
            options += `<option value="${t}" ${t === selectedPerson ? 'selected' : ''}>${t}</option>`;
        });
        
        // 2. åŠ å…¥å›ºå®šã€Œå‡æ”¤ã€é¸é … (åƒ…åœ¨å—ç›Šäºº/æ­¸å±¬äººæ¬„ä½é¡¯ç¤º)
        if (fieldName === 'beneficiary') {
             options += `<option value="å‡æ”¤" ${'å‡æ”¤' === selectedPerson ? 'selected' : ''}>å‡æ”¤ (æ‰€æœ‰äººå¹³åˆ†)</option>`;
        }
        
        // é¡¯ç¤ºé‚è¼¯ (é¡è‰²è™•ç†)
        let color, initial;
        if (selectedPerson === 'å‡æ”¤') {
            color = '#64748b'; // ç‰¹æ®Šç°è‰² for å‡æ”¤
            initial = 'å‡';
        } else {
            const colorIdx = travelers.indexOf(selectedPerson);
            color = colorIdx >= 0 ? generateThemePalette(tripData.themeColor, colorIdx, travelers.length) : '#ccc';
            initial = selectedPerson ? selectedPerson.substring(0,1) : '?';
        }
        
        // é€™æ˜¯ Beneficiary å°ˆç”¨çš„çµæ§‹
        return `
            <div class="traveler-select">
                <div class="select-display" id="display-${id}">
                    <div class="avatar-circle" style="background-color:${color};width:24px;height:24px;font-size:10px;">${initial}</div>
                    <span class="name">${selectedPerson}</span>
                    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </div>
                <select id="${id}" onchange="updateSplitBeneficiary(${actIndex}, '${splitId}', this.value)">
                    ${options}
                </select>
            </div>
        `;
    }
    // --- çµæŸæ—…ä¼´ Select æ¸²æŸ“å·¥å…·å‡½å¼ ---


    function init() { 
      loadProjects(); 
      renderProjectList(); 
      setupIntersectionObserver(); // åˆå§‹åŒ–æ»¾å‹•ç›£è½å™¨
      isInitialLoad = false; // åˆå§‹è¼‰å…¥å®Œæˆ
    }
    
    // --- æ ¸å¿ƒï¼šIntersection Observer è¨­ç½® ---
    function setupIntersectionObserver() {
        if (observer) {
            observer.disconnect(); // æ¸…é™¤èˆŠçš„ç›£è½å™¨
        }
        
        observer = new IntersectionObserver((entries, observer) => {
            entries.forEach((entry, index) => {
                const el = entry.target;
                if (entry.isIntersecting) {
                    // é€²å…¥è¦–çª—
                    if (!el.classList.contains('in-view')) {
                        // è¨ˆç®—äº¤éŒ¯å»¶é² (0ms, 50ms, 100ms, ...)
                        // æ»¾å‹•æ¼¸å…¥åªåœ¨éç·¨è¼¯æ¨¡å¼ä¸‹è§¸ç™¼ï¼Œä»¥ä¿æŒç·¨è¼¯æ¨¡å¼ä¸‹æ‹–æ›³çš„å³æ™‚æ€§
                        if (!isEditMode) {
                            // ä½¿ç”¨ data-index ç¢ºä¿æˆ‘å€‘è¨ˆç®—çš„æ˜¯ DOM é †åºè€Œä¸æ˜¯ IO è§¸ç™¼é †åº
                            const dataIndex = el.dataset.globalIndex || index; 
                            const delay = (dataIndex % 10) * 50; 
                            el.style.transitionDelay = `${delay}ms`;
                        } else {
                            el.style.transitionDelay = '0ms';
                        }
                        el.classList.add('in-view');
                    }
                } else {
                    // é›¢é–‹è¦–çª—ï¼Œå°‡å…¶é‡ç½®ç‚ºéš±è—ç‹€æ…‹ï¼ˆå¦‚æœéœ€è¦é‡è¤‡å‹•ç•«çš„è©±ï¼‰
                    // ç‚ºäº†é¿å…æ»¾å‹•æ™‚å¡é “ï¼Œåªåœ¨åˆ‡æ› Day æ™‚æ‰çœŸæ­£æ¸…é™¤ 'in-view' ç‹€æ…‹
                    // el.classList.remove('in-view'); 
                }
            });
        }, {
            rootMargin: '0px 0px -10% 0px', // æå‰ 10% åº•éƒ¨è§¸ç™¼
            threshold: 0.1 // è‡³å°‘ 10% å…ƒç´ å¯è¦‹
        });
        
        // è¨»å†Šç›®å‰ DOM ä¸­æ‰€æœ‰çš„ timeline-card
        document.querySelectorAll('.timeline-card').forEach(card => observer.observe(card));
    }
    // --- æ ¸å¿ƒï¼šIntersection Observer çµæŸ ---

    function loadProjects() { const raw=localStorage.getItem('trip_projects_v30'); if(raw)projects=JSON.parse(raw); else { projects=[{id:'default',name:'2026é˜ªäº¬ä¹‹æ—…',themeColor:'#C6A664',updatedAt:new Date().toISOString()}]; localStorage.setItem('trip_projects_v30',JSON.stringify(projects)); saveTripData('default',{theme:"2026é˜ªäº¬ä¹‹æ—…",startDate:"2026-01-17",endDate:"2026-01-22",bannerUrl:"https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop",themeColor:"#C6A664",exchangeRate:0.215,baseCurrency:'JPY',checklist:[],shoppingList:[],expenses:[],travelers:['è‡ªå·±','å…¬è²»'],days:{}}); } }
    
    function switchTab(tab) {
        ['screen-project-list','screen-itinerary','screen-lists','screen-chart','screen-expenses'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        document.querySelectorAll('.nav-btn svg, .nav-btn span').forEach(e=>e.classList.replace('text-[var(--theme-color)]','text-gray-400'));
        document.getElementById('nav-itinerary-float').classList.remove('active');
        
        // åœæ­¢èˆŠçš„è§€å¯Ÿè€…ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
        if (observer) observer.disconnect();

        if(tab==='list') backToProjectList();
        else if(tab==='itinerary') { 
            if(!currentProjectId)return backToProjectList(); 
            document.getElementById('screen-itinerary').classList.remove('hidden'); 
            document.getElementById('nav-itinerary-float').classList.add('active'); 
            updateBudgetSummary();
            renderTimeline(true); // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä¸¦è§¸ç™¼ IO
        }
        else if(tab==='lists') { if(!currentProjectId)return backToProjectList(); document.getElementById('screen-lists').classList.remove('hidden'); renderListsPage(); highlightNav('nav-lists'); }
        else if(tab==='expenses') { if(!currentProjectId)return backToProjectList(); document.getElementById('screen-expenses').classList.remove('hidden'); initExpenseForm(); renderExpensesList(); highlightNav('nav-expenses'); }
        else if(tab==='chart') { if(!currentProjectId)return backToProjectList(); document.getElementById('screen-chart').classList.remove('hidden'); renderChartPage(); highlightNav('nav-chart'); }
    }
    
    function highlightNav(id){ const btn=document.getElementById(id); if(btn){ btn.querySelector('svg').classList.replace('text-gray-400','text-[var(--theme-color)]'); btn.querySelector('span').classList.replace('text-gray-400','text-[var(--theme-color)]'); } }
    
    function renderProjectList() { 
        document.documentElement.style.setProperty('--theme-color', '#53565C');
        document.getElementById('screen-project-list').classList.remove('hidden'); 
        const c=document.getElementById('project-list-container'); c.innerHTML=''; 
        projects.forEach(p=>{ const el=document.createElement('div'); el.className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:border-gray-300 transition cursor-pointer group"; el.onclick=()=>enterProject(p.id); el.innerHTML=`<div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${p.themeColor}">${p.name.substring(0,1)}</div><div><h3 class="font-bold text-ink group-hover:text-[var(--theme-color)] transition">${p.name}</h3><p class="text-[10px] text-gray-400 font-sans">${p.updatedAt.split('T')[0]} æ›´æ–°</p></div></div><button onclick="event.stopPropagation(); deleteProject('${p.id}')" class="text-gray-300 hover:text-rose-400 p-2">ğŸ—‘</button>`; c.appendChild(el); }); 
    }
    
    function createNewProject() { const id='proj_'+Date.now(); projects.push({id,name:'æ–°çš„æ—…ç¨‹',themeColor:'#C6A664',updatedAt:new Date().toISOString()}); localStorage.setItem('trip_projects_v30',JSON.stringify(projects)); saveTripData(id,{theme:"æ–°çš„æ—…ç¨‹",startDate:new Date().toISOString().split('T')[0],endDate:new Date().toISOString().split('T')[0],bannerUrl:"https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop",themeColor:"#C6A664",exchangeRate:0.215,baseCurrency:'JPY',checklist:[],shoppingList:[],expenses:[],travelers:['è‡ªå·±'],days:{}}); renderProjectList(); }
    function deleteProject(id) { if(window.confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ projects=projects.filter(p=>p.id!==id); localStorage.setItem('trip_projects_v30',JSON.stringify(projects)); localStorage.removeItem('trip_data_'+id); renderProjectList(); } }
    
    function enterProject(id) { 
        currentProjectId=id; 
        const raw=localStorage.getItem('trip_data_'+id); 
        if(raw) tripData=JSON.parse(raw); 
        if(!tripData.checklist) tripData.checklist=[];
        if(!tripData.shoppingList) tripData.shoppingList=[]; 
        if(!tripData.expenses) tripData.expenses=[];
        if(!tripData.exchangeRate) tripData.exchangeRate=0.215; 
        if(!tripData.baseCurrency) tripData.baseCurrency='JPY';
        if(!tripData.travelers) tripData.travelers=['è‡ªå·±','å…¬è²»']; 
        if(Object.keys(tripData.days).length===0) updateDateRange(); 
        
        currentDisplayCurrency = tripData.baseCurrency;
        switchTab('itinerary'); 
        applyTheme(); 
        renderHeader(); 
        renderDayTabs(); 
        renderTimeline(true); // é¦–æ¬¡é€²å…¥æ™‚å¼·åˆ¶é‡æ–°æ¸²æŸ“ä¸¦è§¸ç™¼ IO
        updateDayHeader(); // ç¢ºä¿æ—¥æœŸé¡¯ç¤º
        updateBudgetSummary(); 
    }
    
    function backToProjectList() { isEditMode=false; currentProjectId=null; renderProjectList(); }
    function saveCurrentTrip() { if(!currentProjectId)return; saveTripData(currentProjectId,tripData); const idx=projects.findIndex(p=>p.id===currentProjectId); if(idx>=0){ projects[idx].name=tripData.theme; projects[idx].themeColor=tripData.themeColor; projects[idx].updatedAt=new Date().toISOString(); localStorage.setItem('trip_projects_v30',JSON.stringify(projects)); } }
    function saveTripData(id,data) { localStorage.setItem('trip_data_'+id,JSON.stringify(data)); }
    
    function applyTheme() { 
        document.documentElement.style.setProperty('--theme-color',tripData.themeColor);
        // NEW: æ›´æ–°æ·ºè‰²ä¸»é¡Œè‰²ç‚ºè«è˜­è¿ªè‰²
        document.documentElement.style.setProperty('--travel-bg-color', generateMorandiColor(tripData.themeColor));
        COLORS[0] = tripData.themeColor;
    }
    
    // --- Image Load/Error Handlers ---
    function handleImageError() {
        const img = document.getElementById('hero-image');
        const header = document.getElementById('hero-header');
        const placeholder = document.getElementById('hero-placeholder');
        
        img.style.opacity = '0'; // Hide the broken image icon
        placeholder.textContent = 'âŒ å°é¢åœ–ç‰‡è¼‰å…¥å¤±æ•—æˆ–éå¤§ (ä½¿ç”¨ä¸»é¡Œè‰²èƒŒæ™¯)';
        placeholder.style.backgroundColor = 'rgba(0,0,0,0.4)';
        placeholder.style.color = 'white';
        header.style.backgroundColor = tripData.themeColor; // Fallback background color
    }

    function handleImageLoad() {
        const img = document.getElementById('hero-image');
        const placeholder = document.getElementById('hero-placeholder');
        
        img.style.opacity = '1';
        placeholder.textContent = ''; // Clear placeholder text
        placeholder.style.backgroundColor = 'transparent';
    }

    function renderHeader() { 
        const imgEl = document.getElementById('hero-image');
        const placeholder = document.getElementById('hero-placeholder');
        const header = document.getElementById('hero-header');
        
        // 1. Reset image state and set loading state
        imgEl.style.opacity = '0';
        imgEl.removeAttribute('src'); 
        placeholder.textContent = 'è¼‰å…¥å°é¢åœ–ç‰‡ä¸­...';
        placeholder.style.backgroundColor = 'transparent';
        placeholder.style.color = 'white';
        header.style.backgroundColor = '#ccc'; // Default color during load attempt

        // 2. Load the image source. This triggers onload/onerror
        imgEl.src = tripData.bannerUrl; 
        
        // If bannerUrl is empty or not set, immediately show error/default state
        if (!tripData.bannerUrl) {
            handleImageError();
            placeholder.textContent = 'ğŸ  æœªè¨­å®šå°é¢åœ–ç‰‡ (ä½¿ç”¨é è¨­èƒŒæ™¯)';
            placeholder.style.backgroundColor = 'transparent';
        }

        // 3. Render content overlay (unchanged)
        const c=document.getElementById('header-content'); 
        c.innerHTML=`<div class="text-[10px] tracking-[0.2em] uppercase opacity-80 mb-2 font-sans animate-fade-in" style="animation-delay: 0.3s; font-weight: bold;">Travel Itinerary</div><h1 class="text-3xl font-serif font-bold tracking-widest drop-shadow-lg text-center px-4 animate-bounce-in" style="animation-delay: 0.4s;">${tripData.theme}</h1><p class="mt-2 text-xs font-bold tracking-wider opacity-90 font-sans animate-fade-in" style="animation-delay: 0.5s;">${new Date(tripData.startDate).toLocaleDateString()} - ${new Date(tripData.endDate).toLocaleDateString()}</p>`;
        
        document.getElementById('edit-theme').value = tripData.theme;
        document.getElementById('edit-start-date').value = tripData.startDate;
        document.getElementById('edit-end-date').value = tripData.endDate;
        document.getElementById('edit-banner-url').value = tripData.bannerUrl; 
        document.getElementById('edit-rate').value = tripData.exchangeRate;
        document.getElementById('edit-currency-code').value = tripData.baseCurrency || 'JPY';
        document.getElementById('edit-color').value = tripData.themeColor;
        document.getElementById('edit-travelers').value = tripData.travelers.join(', ');
    }
    
    // --- é€šç”¨ Toast è¨Šæ¯å‡½æ•¸ ---
    function showToast(message) {
        const b = document.getElementById('message-banner');
        b.textContent = message;
        b.classList.add('toast-active'); 
        setTimeout(() => { b.classList.remove('toast-active'); }, 2500);
    }
    
    // --- UPDATED: è™•ç†åœ–ç‰‡ä¸Šå‚³ä¸¦è½‰æ›ç‚º Base64 (5MB Limit) ---
    function handleBannerUpload(event) {
        const file = event.target.files[0];
        // INCREASED MAX_SIZE from 2MB to 5MB
        const MAX_SIZE = 5 * 1024 * 1024; // 5MB

        if (file) {
            if (file.size > MAX_SIZE) { 
                showToast("åœ–ç‰‡æª”æ¡ˆéå¤§ (é™åˆ¶ 5MB)ï¼Œè«‹æ”¹ç”¨ç¶²å€æˆ–ç¸®å°å¾Œå†ä¸Šå‚³ã€‚");
                event.target.value = null; // Clear file input
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Url = e.target.result;
                const urlInput = document.getElementById('edit-banner-url');
                
                // Clear the URL input and set the new Base64 value
                urlInput.value = base64Url; 
                
                // Update the hidden input value if user pastes a URL next time
                urlInput.focus();
                
                showToast("åœ–ç‰‡å·²è½‰æ›ç‚º Base64 æº–å‚™å„²å­˜ã€‚");
            };
            reader.onerror = function() {
                showToast("æª”æ¡ˆè®€å–å¤±æ•—ã€‚");
            };
            reader.readAsDataURL(file);
        }
    }

    // Helper to update the banner url field when typing
    function updateBannerPreview(url) {
        // When the user manually types or pastes a URL, clear the file input 
        // to avoid confusion on which source to save.
        document.getElementById('banner-file-input').value = null;
    }
    // --- END UPDATED IMAGE UPLOAD ---


    // --- ä¿®æ­£å¾Œçš„é‡ç½®è³‡æ–™åŠŸèƒ½ (Fixed Reset Function) ---
    function resetAllData() {
        if(window.confirm("è­¦å‘Šï¼é€™å°‡æœƒã€Œæ°¸ä¹…åˆªé™¤ã€ç•¶å‰æ‰€æœ‰è¡Œç¨‹èˆ‡è¨­å®šï¼Œä¸¦é‡ç½®ç‚ºåˆå§‹ç‹€æ…‹ã€‚\n\næ­¤æ“ä½œåªæœƒå½±éŸ¿ã€Œç•¶å‰ã€å°ˆæ¡ˆï¼Œä¸æœƒåˆªé™¤å…¶ä»–æ—…ç¨‹ã€‚\n\nç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
            if(currentProjectId) {
                const resetData = {
                    theme: "æ–°çš„æ—…ç¨‹",
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date().toISOString().split('T')[0],
                    bannerUrl: "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop",
                    themeColor: "#C6A664",
                    exchangeRate: 0.215,
                    baseCurrency: 'JPY',
                    checklist: [],
                    shoppingList: [],
                    expenses: [],
                    travelers: ['è‡ªå·±'],
                    days: {}
                };
                tripData = JSON.parse(JSON.stringify(resetData));
                currentDay = 1;
                saveCurrentTrip();
                updateDateRange();
                applyTheme();
                renderHeader();
                renderDayTabs();
                renderTimeline(true);
                updateBudgetSummary();
                if(!document.getElementById('screen-chart').classList.contains('hidden')) { renderChartPage(); }
                showToast("å°ˆæ¡ˆå·²æˆåŠŸé‡ç½®ï¼"); // ä½¿ç”¨ showToast æ›¿æ› alert
            }
        }
    }
    
    function toggleSettings() {
        const modal = document.getElementById('edit-settings-modal');
        if(modal.classList.contains('hidden')) { 
          renderHeader(); 
          modal.classList.remove('hidden'); 
          // Set initial value for banner URL input
          document.getElementById('edit-banner-url').value = tripData.bannerUrl;
          document.getElementById('banner-file-input').value = null; // clear file input on open
          setTimeout(() => { modal.classList.add('show'); }, 10); // è§¸ç™¼ CSS è½‰å ´
        } else {
          modal.classList.remove('show');
          setTimeout(() => { modal.classList.add('hidden'); }, 300); // å»¶é²éš±è—
        }
    }

    function saveAndCloseSettings() {
        const newTheme = document.getElementById('edit-theme').value;
        const newStart = document.getElementById('edit-start-date').value;
        const newEnd = document.getElementById('edit-end-date').value;
        // MODIFIED: Read from the new ID
        const newBanner = document.getElementById('edit-banner-url').value; 
        const newRate = document.getElementById('edit-rate').value;
        const newCurrency = document.getElementById('edit-currency-code').value;
        const newColor = document.getElementById('edit-color').value;
        const newTravelersStr = document.getElementById('edit-travelers').value;

        tripData.theme = newTheme;
        if(newStart && newEnd) {
            tripData.startDate = newStart;
            tripData.endDate = newEnd;
        }
        // MODIFIED: Save the new URL/Base64
        tripData.bannerUrl = newBanner;
        
        tripData.exchangeRate = parseFloat(newRate);
        tripData.baseCurrency = newCurrency;
        tripData.themeColor = newColor;

        if(newTravelersStr.trim()) {
            const newTravelers = newTravelersStr.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t);
            tripData.travelers = newTravelers;
            
            // Update splits: if old traveler is removed, reset splits' beneficiary/payer to first new traveler
            const defaultTraveler = newTravelers[0] || 'è‡ªå·±';
            Object.values(tripData.days).forEach(d => {
                d.activities?.forEach(a => {
                    a.splits?.forEach(s => {
                        // Migration and cleanup (already in previous submission, ensuring stability)
                        if(s.person) { s.beneficiary = s.person; delete s.person; } 
                        if (!s.beneficiary || (!newTravelers.includes(s.beneficiary) && s.beneficiary !== 'å‡æ”¤')) s.beneficiary = defaultTraveler;
                        if (!s.payer || !newTravelers.includes(s.payer)) s.payer = defaultTraveler;
                    });
                    if(a.payer) delete a.payer; // Clean up old activity-level payer
                });
            });
            // Update expenses: if old traveler is removed, reset expenses' beneficiary/payer to first new traveler
            tripData.expenses.forEach(exp => {
                if (!newTravelers.includes(exp.payer)) exp.payer = defaultTraveler;
                if (!newTravelers.includes(exp.beneficiary) && exp.beneficiary !== 'å‡æ”¤') exp.beneficiary = defaultTraveler;
            });

        }
        
        applyTheme();
        saveCurrentTrip();
        updateDateRange();
        
        currentDisplayCurrency = tripData.baseCurrency;

        toggleSettings(); // é—œé–‰æ¨¡æ…‹æ¡†
        renderHeader();
        renderDayTabs(); 
        renderTimeline(true); 
        updateBudgetSummary();
    }

    function toggleContentEdit() { 
        isEditMode = !isEditMode; 
        const btn = document.getElementById('edit-content-btn');
        const tpl = document.getElementById('template-actions');
        const addBtn = document.getElementById('add-act-btn');
        const quickAddBtn = document.getElementById('quick-add-act-btn');

        if(isEditMode) { 
            btn.classList.add('active'); 
            addBtn.classList.remove('hidden'); 
            tpl.classList.remove('hidden'); 
            quickAddBtn.classList.add('hidden'); // ç·¨è¼¯æ¨¡å¼ä¸‹éš±è—å¿«é€Ÿæ–°å¢æŒ‰éˆ•
        } 
        else { 
            btn.classList.remove('active'); 
            addBtn.classList.add('hidden'); 
            tpl.classList.add('hidden'); 
            quickAddBtn.classList.remove('hidden'); // æ¢å¾©é¡¯ç¤ºå¿«é€Ÿæ–°å¢æŒ‰éˆ•
        }
        renderTimeline(true); // é‡æ–°æ¸²æŸ“ï¼Œè®“å¡ç‰‡ç‹€æ…‹åæ˜ ç·¨è¼¯æ¨¡å¼
    }

    function updateMeta(f,v) { tripData[f]=v; if(f==='themeColor')applyTheme(); saveCurrentTrip(); renderHeader(); }
    
    function updateDateRange() { 
        const s = new Date(tripData.startDate);
        const e = new Date(tripData.endDate);
        if (e < s) tripData.endDate = tripData.startDate;
        const daysDiff = Math.ceil((new Date(tripData.endDate) - new Date(tripData.startDate)) / (1000 * 60 * 60 * 24)) + 1;
        const newDays = {};
        for(let i=1; i<=daysDiff; i++) {
            const d = new Date(s); d.setDate(d.getDate() + i - 1);
            const dateStr = d.toISOString().split('T')[0];
            const key = `Day ${i}`;
            const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
            const defaultCurrency = tripData.baseCurrency || 'JPY';
            const defaultSplit = [{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: defaultCurrency }];
            
            if (tripData.days[key]) { 
                newDays[key] = tripData.days[key]; 
                newDays[key].date = dateStr; 
                
                // DATA MIGRATION: Ensure old structure is converted
                newDays[key].activities?.forEach(act => {
                    // Split migration logic (remains the same)
                    if (act.splits && !Array.isArray(act.splits)) {
                        let tempSplits = [];
                        if (typeof act.splits === 'object' && act.splits !== null) {
                            const activityPayer = act.payer || defaultTraveler;
                            Object.entries(act.splits).forEach(([person, amount]) => {
                                tempSplits.push({ 
                                    id: uuidv4(), 
                                    beneficiary: person, 
                                    payer: activityPayer, 
                                    amount: amount,
                                    currency: act.currency || defaultCurrency
                                });
                            });
                        }
                        act.splits = tempSplits.length > 0 ? tempSplits : JSON.parse(JSON.stringify(defaultSplit));
                        if(act.payer) delete a.payer; 
                    } else if (act.splits && Array.isArray(act.splits)) {
                        act.splits = act.splits.map(s => {
                            if(s.person) { s.beneficiary = s.person; delete s.person; }
                            if(!s.payer) s.payer = act.payer || defaultTraveler;
                            if(!s.beneficiary) s.beneficiary = defaultTraveler; 
                            if(!s.currency) s.currency = act.currency || defaultCurrency;
                            return s;
                        });
                        if(act.payer) delete a.payer; 
                    } else {
                        act.splits = JSON.parse(JSON.stringify(defaultSplit));
                    }
                    
                    // ç§»é™¤: Travel migration (ensure structure is present)
                    if (act.travel) {
                        delete act.travel;
                    }
                });
                
            } else { 
                const templ = JSON.parse(JSON.stringify(TEMPLATES.general));
                templ.forEach(t => { 
                    t.splits = JSON.parse(JSON.stringify(defaultSplit)); 
                    t.currency = t.currency || defaultCurrency;
                    // ç§»é™¤: Ensure travel field is initialized for new template activities
                    if (t.travel) delete t.travel;
                });
                newDays[key] = { date: dateStr, location: "LOCATION", activities: templ }; 
            }
        }
        tripData.days = newDays;
        if (currentDay > daysDiff) currentDay = 1;
        saveCurrentTrip();
    }

    function renderDayTabs() { 
        const c=document.getElementById('day-scroll-container'); 
        c.innerHTML=''; 
        
        Object.keys(tripData.days).forEach((k,idx)=>{ 
            const i=idx+1, btn=document.createElement('button'), active=i===currentDay; 
            btn.className=`smooth-scroll-item flex-shrink-0 w-[56px] h-[56px] flex flex-col items-center justify-center transition-all duration-300 snap-start ${active?'day-tab-active':'day-tab-inactive'}`; 
            
            // æ–°å¢ä¸€å€‹å°å°çš„å»¶é²ï¼Œè®“ Day Tabs å‡ºç¾æ™‚ä¹Ÿæœ‰äº¤éŒ¯æ„Ÿ
            btn.style.animation = `fade-in 0.3s ease-out forwards ${0.05 * idx}s`; 

            btn.onclick=()=>{
                currentDay=i; 
                renderDayTabs(); 
                renderTimeline(true); // åˆ‡æ› Day æ™‚å¼·åˆ¶é‡æ–°æ¸²æŸ“ä¸¦è§¸ç™¼ IO
                updateDayHeader(); 
                btn.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})
            }; 
            btn.innerHTML=`<span class="text-[9px] uppercase font-sans opacity-80">Day</span><span class="text-lg font-serif font-bold leading-none mt-0.5">${i}</span>`; 
            c.appendChild(btn); 
        }); 
    }
    function applyDayTemplate(t) { 
        if(window.confirm("å¥—ç”¨æ¨¡æ¿ï¼Ÿ")) { 
            const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
            const defaultCurrency = tripData.baseCurrency || 'JPY';
            const defaultSplit = [{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: defaultCurrency }];

            const templ = JSON.parse(JSON.stringify(TEMPLATES[t]));
            templ.forEach(a => { 
                if (!a.splits || a.splits.length === 0) {
                    a.splits = JSON.parse(JSON.stringify(defaultSplit));
                }
                a.currency = a.currency || defaultCurrency;
                if(a.payer) delete a.payer; 
                // ç§»é™¤: Travel field for templates
                if (a.travel) delete a.travel;
            });
            
            tripData.days[`Day ${currentDay}`].activities=templ; 
            saveCurrentTrip();
            renderTimeline(true); // å¥—ç”¨æ¨¡æ¿å¾Œå¼·åˆ¶è§¸ç™¼ IO
            
        } 
    }
    
    
    // Render Timeline 
    // forceRenderAndObserve: å¼·åˆ¶æ¸…é™¤ in-view ç‹€æ…‹ä¸¦é‡æ–°è¨»å†Š IO
    function renderTimeline(forceRenderAndObserve = false) {
        const c=document.getElementById('timeline-container'); c.innerHTML='';
        const activities = tripData.days[`Day ${currentDay}`]?.activities || [];
        const baseCurr = tripData.baseCurrency || 'JPY';
        const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;
        const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
        let globalCardIndex = 0;

        // åœæ­¢èˆŠçš„è§€å¯Ÿè€…
        if (observer) {
            observer.disconnect();
        }
        
        // 1. æ¸²æŸ“æ´»å‹•å¡ç‰‡
        activities.forEach((act, idx) => {
            // --- è³‡æ–™çµæ§‹ç¢ºä¿ ---
            if (!act.splits || !Array.isArray(act.splits) || act.splits.length === 0) {
                act.splits = [{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: act.currency || baseCurr }];
            } else {
                 act.splits = act.splits.map(s => {
                    if (s.person) { s.beneficiary = s.person; delete s.person; }
                    if (!s.payer) s.payer = defaultTraveler;
                    if (!s.beneficiary) s.beneficiary = defaultTraveler; 
                    if (!s.currency) s.currency = act.currency || baseCurr;
                    return s;
                });
            }
            if(act.payer) delete a.payer; 
            
            // ç§»é™¤: Travel field check/initialization
            if (act.travel) delete act.travel;
            
            // --- è¨ˆç®—é¡¯ç¤ºé‡‘é¡ ---
            let totalCost = act.splits.reduce((sum, s) => sum + (s.amount || 0), 0);
            let secondaryCostDisplay = '';
            const rate = tripData.exchangeRate || 0.215;
            
            if(act.currency !== 'TWD') {
                const twdVal = Math.round(totalCost * rate);
                secondaryCostDisplay = `â‰ˆ NT$ ${twdVal.toLocaleString()}`;
            } else {
                const foreignVal = Math.round(totalCost / rate);
                secondaryCostDisplay = `(${baseSymbol} ${foreignVal.toLocaleString()})`;
            }

            let isExpanded = false;
            if (act.manualState === 'open') isExpanded = true;
            else if (act.manualState === 'closed') isExpanded = false;
            else isExpanded = (totalCost > 0);
            
            // ç²å–æ·ºè‰²èƒŒæ™¯ (ç¢ºä¿åœ¨æ¸²æŸ“æ´»å‹•å¡ç‰‡ä¹‹å‰ï¼ŒCSS è®Šæ•¸å·²ç¶“æ›´æ–°)
            const cardBgColor = document.documentElement.style.getPropertyValue('--travel-bg-color') || '#FFFFFF';

            const el=document.createElement('div'); 
            
            // æ ¸å¿ƒ: åŠ å…¥ timeline-card classï¼Œä¸¦æ ¹æ“šæ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ä¾†æ±ºå®šåˆå§‹ç‹€æ…‹
            let initialClass = 'timeline-card';
            if (isEditMode || !forceRenderAndObserve) {
                initialClass = 'timeline-card in-view';
            } else {
                initialClass = 'timeline-card';
            }
            
            // æ ¸å¿ƒä¿®æ”¹: ç§»é™¤ timeline-travel-card é¡å
            el.className=`relative flex flex-col md:flex-row overflow-hidden rounded-2xl shadow-sm border border-gray-100 group bg-white hover:shadow-md transition-all duration-300 ml-6 drag-item my-4 ${initialClass}`; 
            el.dataset.index = idx;
            el.dataset.globalIndex = globalCardIndex; // è¨­ç½®å…¨å±€ç´¢å¼•
            globalCardIndex++; // å¢åŠ å…¨å±€ç´¢å¼•

            // Drag Events (unchanged)
            el.addEventListener('dragstart', handleSortableDragStart); 
            el.addEventListener('dragover', handleSortableDragOver); 
            el.addEventListener('drop', handleActivityDrop); 
            el.addEventListener('touchstart', handleSortableTouchStart, {passive: false});
            el.addEventListener('touchmove', handleActivityTouchMove, {passive: false});
            el.addEventListener('touchend', handleSortableTouchEnd);

            const dot = document.createElement('div'); dot.className = 'timeline-dot'; c.appendChild(dot);

            // --- åˆ†å¸³ HTML ç”Ÿæˆ ---
            let splitsHtml = '';
            const cardSymbol = act.currency === 'TWD' ? 'NT$' : baseSymbol;
            
            act.splits.forEach((splitItem, sIdx) => { 
                const beneficiary = splitItem.beneficiary; 
                const payer = splitItem.payer; 
                const val = splitItem.amount;
                const splitId = splitItem.id; 
                
                const beneSelectHtml = renderTravelerSelect(idx, splitId, beneficiary, tripData.travelers, 'beneficiary');
                let payerOptionsHtml = tripData.travelers.map(t => `<option value="${t}" ${t === payer ? 'selected' : ''}>${t}</option>`).join('');

                splitsHtml += `<div class="flex items-center justify-between gap-1 py-1 group border-b border-gray-50 last:border-b-0">
                  <div class="flex-1 min-w-0">${beneSelectHtml}</div>
                  <div class="flex items-center gap-1 flex-shrink-0 w-1/3 min-w-[100px]">
                    <span class="text-gray-400 font-serif mr-1 text-sm">â‡¢</span>
                    <select onchange="updateSplitPayer(${idx}, '${splitId}', this.value)" class="text-xs w-full border-b border-gray-300 bg-transparent text-gray-600 focus:border-[var(--theme-color)] py-0 h-6 outline-none">${payerOptionsHtml}</select>
                  </div>
                  <div class="flex items-center gap-1 flex-shrink-0 ml-1">
                    <div class="flex items-baseline gap-1">
                      <span class="text-[10px] text-gray-400">${cardSymbol}</span>
                      <input type="number" value="${val}" onchange="updateSplitAmount(${idx}, '${splitId}', this.value)" class="w-14 text-base font-bold text-ink bg-transparent border-b border-gray-300 text-right focus:border-[var(--theme-color)] outline-none" placeholder="0">
                    </div>
                    <button onclick="deleteSplit(${idx}, '${splitId}')" class="text-gray-300 hover:text-rose-500 w-5 h-5 flex items-center justify-center transition"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M8.75 12.75a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5h-3.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M16 6a1 1 0 011 1v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a1 1 0 011-1h12zM5.555 7.5a.75.75 0 00-1.5 0v.75a.75.75 0 001.5 0v-.75zM15 7.5a.75.75 0 00-1.5 0v.75a.75.75 0 001.5 0v-.75zM8 3a1 1 0 011-1h2a1 1 0 011 1h4a1 1 0 011 1v1H3V4a1 1 0 011-1h4z" clip-rule="evenodd" /></svg></button>
                  </div>
                </div>`;
            });

            const addressHtml = act.address ? `<div class="flex items-start gap-2 mb-2 mt-2 text-xs text-gray-400 font-sans group/addr"><span class="flex-shrink-0 mt-0.5">ğŸ“®</span><span class="truncate max-w-[200px] select-text">${act.address}</span><button onclick="copyText('${act.address}', 'åœ°å€')" class="opacity-50 hover:opacity-100 hover:text-[var(--theme-color)] transition" title="è¤‡è£½åœ°å€">ğŸ“‹</button></div>` : '';
            const descHtml = act.desc ? `<div class="flex items-start gap-2 mb-3 mt-2 text-xs font-bold text-gray-500 font-sans select-text"><span class="flex-shrink-0 mt-0.5">ğŸ“</span><p class="whitespace-pre-wrap leading-relaxed">${act.desc}</p></div>` : '';
            const dragHandleHtml = `<div class="drag-handle-btn cursor-grab active:cursor-grabbing p-2 text-gray-300 hover:text-[var(--theme-color)] flex items-center justify-center transition" title="æ‹–æ›³æ’åº" draggable="true"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>`;
            
            // --- Email Copy Button ---
            const emailBtnHtml = act.email ? `<button onclick="event.stopPropagation(); copyText('${act.email}', 'ä¿¡ç®±')" class="bg-gray-50 hover:bg-orange-50 text-gray-400 hover:text-orange-500 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1" title="è¤‡è£½ä¿¡ç®±">ğŸ“§ ä¿¡ç®±</button>` : '';

            // --- Edit Mode HTML ---
            const editModeHtml = `
                <div class="edit-mode hidden w-full p-4 bg-white">
                    <div class="flex gap-2 mb-3">
                        <input type="text" class="edit-icon w-10 text-center bg-gray-50 rounded border border-gray-200 py-1" value="${act.icon}">
                        <input type="time" class="edit-time shrink-0 font-sans text-sm text-gray-600 border border-gray-200 rounded px-2 py-1" value="${act.time}">
                        <input type="text" class="edit-label flex-1 min-w-0 text-base font-sans text-ink border border-gray-200 rounded px-2 py-1" value="${act.label||''}" placeholder="æ´»å‹•æ¨™ç±¤">
                    </div>
                    <input type="text" class="edit-location w-full text-lg font-serif font-bold text-ink mb-2 border-b border-gray-300 pb-1" value="${act.location}" placeholder="åœ°é»åç¨±">
                    <div class="flex gap-2 mb-2 bg-gray-50 p-2 rounded">
                        <span class="text-xs">ğŸ“®</span>
                        <input type="text" class="edit-address w-full text-xs bg-transparent border-none p-0 focus:ring-0" value="${act.address||''}" placeholder="è¼¸å…¥åœ°å€">
                    </div>
                    <div class="flex gap-2 mb-2 bg-gray-50 p-2 rounded">
                        <span class="text-xs">ğŸ“§</span>
                        <input type="text" class="edit-email w-full text-xs bg-transparent border-none p-0 focus:ring-0" value="${act.email||''}" placeholder="è¼¸å…¥ç›¸é—œä¿¡ç®± (ä¾‹å¦‚è¨‚æˆ¿/ç¥¨åˆ¸è¯çµ¡ä¿¡ç®±)">
                    </div>
                    <div class="mb-3"><label class="text-xs text-gray-400 block mb-1">è¨ˆè²»å¹£åˆ¥</label><select class="edit-currency w-full text-sm border border-gray-200 rounded px-2 py-1 bg-white"><option value="${baseCurr}" ${act.currency !== 'TWD' ? 'selected' : ''}>${baseSymbol} ${baseCurr}</option><option value="TWD" ${act.currency !== 'TWD' ? 'selected' : ''}>NT$ TWD å°å¹£</option></select></div>
                    <textarea class="edit-desc w-full text-sm text-sub resize-none h-20 border border-gray-200 rounded p-2 mb-3" placeholder="å‚™è¨»...">${act.desc||''}</textarea>
                    <div class="flex gap-2"><button onclick="saveActivity(${idx})" class="flex-1 py-2 bg-[var(--theme-color)] text-white text-xs rounded shadow font-bold">å„²å­˜ä¿®æ”¹</button><button onclick="toggleEditActivity(${idx})" class="px-4 py-2 bg-gray-100 text-gray-500 text-xs rounded shadow">å–æ¶ˆ</button></div>
                </div>
            `;

            el.innerHTML = `
                <div class="view-mode w-full flex flex-col md:flex-row relative">
                    <div class="absolute top-2 right-2 flex items-center gap-1 z-10 card-actions bg-white/80 backdrop-blur rounded-full pl-1">
                        ${dragHandleHtml}
                        <div class="w-[1px] h-4 bg-gray-200 mx-1"></div>
                        <button onclick="event.stopPropagation(); toggleEditActivity(${idx})" class="w-7 h-7 rounded-full hover:bg-[var(--theme-color)] hover:text-white transition flex items-center justify-center text-gray-400" title="ç·¨è¼¯">âœ</button>
                        <button onclick="event.stopPropagation(); deleteAct(${idx})" class="w-7 h-7 rounded-full hover:bg-rose-500 hover:text-white transition flex items-center justify-center text-rose-300" title="åˆªé™¤">âœ•</button>
                    </div>
                    <div class="p-5 w-full md:flex-1 md:w-auto transition-all duration-300 relative">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-xs font-sans text-gray-400 tracking-widest">${act.time}</span>
                            <span class="text-[10px] text-[var(--theme-color)] font-bold tracking-[0.2em] uppercase font-sans bg-[var(--theme-color)]/5 px-2 py-0.5 rounded">${act.label||'VISIT'}</span>
                        </div>
                        <h3 class="text-2xl font-serif font-bold text-ink leading-tight flex items-center gap-2 select-text">${act.icon} ${act.location}</h3>
                        ${addressHtml}
                        ${descHtml}
                        
                        <div class="flex gap-2 mt-auto pt-2">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(act.address || act.location)}" target="_blank" class="bg-gray-50 hover:bg-sky-50 text-gray-400 hover:text-sky-600 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1" onclick="event.stopPropagation()">ğŸ—ºï¸ å°èˆª</a>
                            ${emailBtnHtml}
                            <button onclick="togglePanel(${idx})" class="bg-gray-50 hover:bg-[var(--theme-color)]/10 text-gray-400 hover:text-[var(--theme-color)] px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 ${isExpanded ? 'bg-[var(--theme-color)]/10 text-[var(--theme-color)]' : ''}">ğŸ’´ ${isExpanded ? 'æ”¶èµ·' : 'è¨˜å¸³'}</button>
                        </div>
                    </div>
                    <div class="expense-panel-responsive ${isExpanded?'open':''}">
                        <div class="min-w-[280px] space-y-3 px-4 py-4 md:px-6">
                            <div class="flex items-center gap-1 border-b border-gray-200/60 pb-2 mb-2">
                                <span class="text-lg">${getCategoryIcon(act.costType)}</span>
                                <select onchange="updateAct(${idx},'costType',this.value)" class="bg-transparent text-sm font-bold text-ink outline-none appearance-none cursor-pointer mr-2 w-16">
                                    <option value="é£Ÿ" ${act.costType=='é£Ÿ'?'selected':''}>é£Ÿ</option><option value="è¡£" ${act.costType=='è¡£'?'selected':''}>è¡£</option><option value="ä½" ${act.costType=='ä½'?'selected':''}>ä½</option>
                                    <option value="è¡Œ" ${act.costType=='è¡Œ'?'selected':''}>è¡Œ</option><option value="è‚²" ${act.costType=='è‚²'?'selected':''}>è‚²</option><option value="æ¨‚" ${act.costType=='æ¨‚'?'selected':''}>æ¨‚</option>
                                    <option value="è³¼" ${act.costType=='è³¼'?'selected':''}>è³¼</option><option value="é›œ" ${act.costType=='é›œ'?'selected':''}>é›œ</option>
                                </select>
                            </div>
                            <div class="mb-2"><input type="text" value="${act.expenseDetail || ''}" onchange="updateAct(${idx},'expenseDetail',this.value)" class="w-full text-xs border-b border-gray-200 py-1 bg-transparent focus:border-[var(--theme-color)]" placeholder="æ¶ˆè²»ç´°é …"></div>
                            
                            <div class="flex items-center justify-between gap-1 mt-4 mb-1 px-1">
                                <div class="flex-1 text-[10px] text-gray-400 font-bold pl-1">æ­¸å±¬äºº (èŠ±è²»è€…)</div>
                                <div class="w-1/3 min-w-[100px] text-[10px] text-gray-400 font-bold pl-1">ä»˜æ¬¾äºº (å…ˆå¢Š)</div>
                                <div class="w-20 text-[10px] text-gray-400 text-center pr-6">é‡‘é¡</div>
                            </div>

                            ${splitsHtml}

                            <button onclick="addSplit(${idx})" class="text-sm font-bold text-[var(--theme-color)] mt-2 hover:opacity-80 transition flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>
                                æ–°å¢åˆ†å¸³é …ç›®
                            </button>
                            
                            <div class="flex items-baseline justify-between pt-2 border-t border-gray-200/50 mt-2">
                                <span class="text-xs text-gray-400 font-bold">TOTAL</span>
                                <div class="flex flex-col items-end">
                                    <div class="text-2xl font-serif font-medium text-ink">${cardSymbol} ${totalCost.toLocaleString()}</div>
                                    <div class="text-xs text-gray-400 font-sans font-medium">${secondaryCostDisplay}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${editModeHtml}
            `;
            c.appendChild(el);
            
            // ç§»é™¤: æ’å…¥ Travel Mini-Card (éæœ€å¾Œä¸€é …)
            
        });
        
        // 2. é‡æ–°è¨»å†Š Intersection Observer
        setupIntersectionObserver();
        
        updateBudgetSummary();
    }
    
    // --- æ–°å¢/åˆªé™¤/æ›´æ–°åˆ†å¸³ç®¡ç†å‡½å¼ ---
    
    function updateSplitAmount(actIndex, splitId, val) {
        const act = tripData.days[`Day ${currentDay}`].activities[actIndex];
        const splitItem = act.splits.find(s => s.id === splitId);
        
        if (splitItem) {
            splitItem.amount = parseInt(val) || 0;
            saveCurrentTrip();
            // ä¸è§¸ç™¼ renderTimelineï¼Œåƒ…æ›´æ–°ç¸½çµç®—ï¼Œæå‡æ•ˆèƒ½
            updateBudgetSummary(); 
            // æ‰‹å‹•æ›´æ–°å¡ç‰‡ç¸½é¡é¡¯ç¤º (ç°¡åŒ–è™•ç†)
            const cardEl = document.querySelector(`div[data-index="${actIndex}"]`);
            if(cardEl) {
                const totalCost = act.splits.reduce((sum, s) => sum + (s.amount || 0), 0);
                const totalDisplay = cardEl.querySelector('.expense-panel-responsive .text-2xl');
                if(totalDisplay) {
                     const cardSymbol = act.currency === 'TWD' ? 'NT$' : CURRENCY_SYMBOLS[act.currency] || act.currency;
                     totalDisplay.innerHTML = `${cardSymbol} ${totalCost.toLocaleString()}`;
                }
            }
        }
    }

    // New function to update the beneficiary (who consumed)
    function updateSplitBeneficiary(actIndex, splitId, newBeneficiary) {
        const act = tripData.days[`Day ${currentDay}`].activities[actIndex];
        const splitItem = act.splits.find(s => s.id === splitId);
        
        if (splitItem) {
            splitItem.beneficiary = newBeneficiary;
            saveCurrentTrip();
            
            // ç«‹å³æ›´æ–°æ­¸å±¬äººè¦–è¦º (è‡ªå®šç¾©ä¸‹æ‹‰é¸å–®éœ€è¦æ‰‹å‹• DOM æ“ä½œ)
            const id = `beneficiary-${actIndex}-${splitId}`;
            const displayAvatar = document.querySelector(`#display-${id} .avatar-circle`);
            const displayName = document.querySelector(`#display-${id} .name`);
            if (displayAvatar && displayName) {
                let color, initial;
                if (newBeneficiary === 'å‡æ”¤') {
                    color = '#64748b';
                    initial = 'å‡';
                } else {
                    const colorIdx = tripData.travelers.indexOf(newBeneficiary);
                    color = colorIdx >= 0 ? generateThemePalette(tripData.themeColor, colorIdx, tripData.travelers.length) : '#ccc';
                    initial = newBeneficiary.substring(0, 1);
                }
                displayAvatar.style.backgroundColor = color;
                displayAvatar.textContent = initial;
                displayName.textContent = newBeneficiary;
            }

            // æ­¸å±¬äººè®Šå‹•å½±éŸ¿çµ±è¨ˆåœ–è¡¨ï¼Œéœ€è¦æ›´æ–°ç¸½çµç®—
            updateBudgetSummary(); 
        }
    }
    
    // New function to update the payer (who paid)
    function updateSplitPayer(actIndex, splitId, newPayer) {
        const act = tripData.days[`Day ${currentDay}`].activities[actIndex];
        const splitItem = act.splits.find(s => s.id === splitId);
        
        if (splitItem) {
            splitItem.payer = newPayer;
            saveCurrentTrip();
            // ä»˜æ¬¾äººè®Šå‹•å½±éŸ¿çµ±è¨ˆåœ–è¡¨ï¼Œéœ€è¦æ›´æ–°ç¸½çµç®—
            updateBudgetSummary(); 
        }
    }

    // --- ä¿®æ­£å¾Œçš„åˆªé™¤æ´»å‹•åŠŸèƒ½ (Fixed Delete Activity) ---
    function deleteAct(idx) { 
        if(window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•ç¯€é»å—ï¼Ÿ')) { // ä½¿ç”¨ window.confirm ç¶­æŒæ—¢æœ‰æç¤ºæ¨£å¼
            const dayKey = `Day ${currentDay}`;
            if(tripData && tripData.days && tripData.days[dayKey] && tripData.days[dayKey].activities) {
                const deleted = tripData.days[dayKey].activities.splice(idx,1); 
                
                saveCurrentTrip();
                renderTimeline(true); // åˆªé™¤å¾Œå¼·åˆ¶è§¸ç™¼ IO
                updateBudgetSummary(); // ç¢ºä¿åˆªé™¤å¾Œè²»ç”¨ç¸½çµç«‹å³æ›´æ–°

                if (deleted.length > 0) {
                     showToast(`å·²åˆªé™¤æ´»å‹•: ${deleted[0].location || 'æœªå‘½åæ´»å‹•'}`);
                }
            } else {
                showToast("éŒ¯èª¤ï¼šç„¡æ³•æ‰¾åˆ°è©²æ´»å‹•æ¸…å–®ã€‚");
            }
        } 
    }

    function deleteSplit(actIndex, splitId) {
        if(window.confirm(`ç¢ºå®šè¦å°‡æ­¤åˆ†å¸³é …ç›®ç§»é™¤å—ï¼Ÿ`)) {
            const act = tripData.days[`Day ${currentDay}`].activities[actIndex];
            
            // ç§»é™¤è©² ID çš„åˆ†å¸³é …ç›®
            act.splits = act.splits.filter(s => s.id !== splitId);

            // ç¢ºä¿åˆ†å¸³æ¸…å–®è‡³å°‘è¦æœ‰ä¸€å€‹é …ç›®ï¼Œé™¤éæ—…ä¼´åå–®æ˜¯ç©ºçš„
            if (act.splits.length === 0 && tripData.travelers.length > 0) {
                 const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
                 act.splits.push({ 
                    id: uuidv4(), 
                    beneficiary: defaultTraveler, 
                    payer: defaultTraveler, 
                    amount: 0, 
                    currency: act.currency || tripData.baseCurrency 
                 });
            }

            saveCurrentTrip();
            renderTimeline();
            updateBudgetSummary();
        }
    }
    
    function addSplit(actIndex) {
        const act = tripData.days[`Day ${currentDay}`].activities[actIndex];
        
        if (tripData.travelers.length === 0) {
            showToast('è«‹å…ˆåœ¨æ—…ç¨‹è¨­å®šä¸­æ–°å¢æ—…ä¼´åå–®ã€‚'); // ä½¿ç”¨ showToast
            return;
        }

        const defaultTraveler = tripData.travelers[0];
        // æ–°å¢ä¸€å€‹æ–°çš„åˆ†å¸³ç‰©ä»¶ï¼Œé è¨­ä»˜æ¬¾äºº/æ­¸å±¬äººç‚ºç¬¬ä¸€å€‹æ—…ä¼´
        act.splits.push({ 
            id: uuidv4(), 
            beneficiary: defaultTraveler, 
            payer: defaultTraveler, 
            amount: 0, 
            currency: act.currency || tripData.baseCurrency
        });

        saveCurrentTrip();
        renderTimeline();
    }
    // --- çµæŸåˆ†å¸³ç®¡ç†å‡½å¼ ---


    function toggleEditActivity(idx) {
        const c = document.getElementById('timeline-container');
        const cardEl = c.querySelector(`div[data-index="${idx}"]`);
        if(!cardEl) return;
        const view = cardEl.querySelector('.view-mode');
        const edit = cardEl.querySelector('.edit-mode');
        if(view.classList.contains('hidden')) { view.classList.remove('hidden'); edit.classList.add('hidden'); } else { view.classList.add('hidden'); edit.classList.remove('hidden'); }
    }

    // è¼”åŠ©å‡½å¼ï¼šæŒ‰æ™‚é–“æ’åºç•¶å‰ Day çš„æ´»å‹•
    function sortCurrentDayActivities() {
        const dayKey = `Day ${currentDay}`;
        if (tripData.days[dayKey] && Array.isArray(tripData.days[dayKey].activities)) {
            tripData.days[dayKey].activities.sort((a, b) => {
                return (a.time || '00:00').localeCompare(b.time || '00:00');
            });
        }
    }

    function saveActivity(idx) {
        const c = document.getElementById('timeline-container');
        const cardEl = c.querySelector(`div[data-index="${idx}"]`);
        
        const newIcon = cardEl.querySelector('.edit-icon').value;
        const newTime = cardEl.querySelector('.edit-time').value;
        const newLabel = cardEl.querySelector('.edit-label').value;
        const newLoc = cardEl.querySelector('.edit-location').value;
        const newAddr = cardEl.querySelector('.edit-address').value;
        const newEmail = cardEl.querySelector('.edit-email').value; // Get Email
        const newDesc = cardEl.querySelector('.edit-desc').value;
        const newCurrency = cardEl.querySelector('.edit-currency').value;

        tripData.days[`Day ${currentDay}`].activities[idx].icon = newIcon;
        tripData.days[`Day ${currentDay}`].activities[idx].time = newTime;
        tripData.days[`Day ${currentDay}`].activities[idx].label = newLabel;
        tripData.days[`Day ${currentDay}`].activities[idx].location = newLoc;
        tripData.days[`Day ${currentDay}`].activities[idx].address = newAddr;
        tripData.days[`Day ${currentDay}`].activities[idx].email = newEmail; // Save Email
        tripData.days[`Day ${currentDay}`].activities[idx].desc = newDesc;
        tripData.days[`Day ${currentDay}`].activities[idx].currency = newCurrency;
        
        // Update currency in all splits
        tripData.days[`Day ${currentDay}`].activities[idx].splits.forEach(s => s.currency = newCurrency);

        // --- æ ¸å¿ƒä¿®æ”¹: å„²å­˜å¾Œç«‹å³æ’åº ---
        sortCurrentDayActivities();
        // ------------------------------------

        saveCurrentTrip();
        renderTimeline(true); // å„²å­˜å¾Œé‡æ–°æ¸²æŸ“ä¸¦è§¸ç™¼ IO
        showToast("æ´»å‹•å·²å„²å­˜ä¸¦æŒ‰æ™‚é–“æ’åºå®Œæˆï¼");
    }
    
    function getCategoryIcon(t) { const m={'é£Ÿ':'ğŸš','è¡£':'ğŸ‘•','ä½':'ğŸ¨','è¡Œ':'ğŸš†','è‚²':'ğŸ«','æ¨‚':'ğŸ¡','è³¼':'ğŸ›ï¸','é›œ':'ğŸ”§'}; return m[t]||'ğŸ’°'; }
    function togglePanel(idx) { const act = tripData.days[`Day ${currentDay}`].activities[idx]; let totalCost = act.splits.reduce((sum, s) => sum + (s.amount || 0), 0); let currentlyOpen = act.manualState === 'open' || (act.manualState !== 'closed' && totalCost > 0); act.manualState = currentlyOpen ? 'closed' : 'open'; renderTimeline(); saveCurrentTrip(); }
    function updateAct(idx,f,v) { tripData.days[`Day ${currentDay}`].activities[idx][f]=v; saveCurrentTrip(); }
    function addActivity() { 
        const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
        const defaultCurrency = tripData.baseCurrency || 'JPY';
        tripData.days[`Day ${currentDay}`].activities.push({
            time:"12:00",icon:"ğŸ“",label:"SPOT",location:"æ–°åœ°é»",address:"",email:"",desc:"",costType:"é£Ÿ",expenseDetail:"",
            splits:[{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: defaultCurrency }],
            currency: defaultCurrency
            // ç§»é™¤: travel: { mode: 'walk', duration: 0 } 
        }); 
        
        // --- æ ¸å¿ƒä¿®æ”¹: æ–°å¢å¾Œç«‹å³æ’åº ---
        sortCurrentDayActivities();
        // ------------------------------------

        saveCurrentTrip(); // å„²å­˜æ–°å¢çš„æ´»å‹•
        renderTimeline(true); // é‡æ–°æ¸²æŸ“æ™‚é–“è»¸ä¸¦è§¸ç™¼ IO
        showToast("å·²æ–°å¢æ´»å‹•ç¯€é»ä¸¦æŒ‰æ™‚é–“æ’åºå®Œæˆï¼");
    }
    
    // ä¿®æ­£æ—¥æœŸé¡¯ç¤ºå•é¡Œï¼šç¢ºä¿æ—¥æœŸè¢«æ­£ç¢ºæ ¼å¼åŒ–å’Œé¡¯ç¤ºï¼ˆå¹´/æœˆ/æ—¥ï¼‰
    function updateDayHeader() { 
        const k=`Day ${currentDay}`, d=tripData.days[k]; 
        document.getElementById('current-day-heading').textContent=k; 
        if(d){ 
            try {
                // å˜—è©¦å°‡ YYYY-MM-DD æ ¼å¼åŒ–ç‚º YYYY/M/D 
                const dateObj = new Date(d.date + 'T00:00:00'); // é¿å…æ™‚å€å½±éŸ¿
                const formattedDate = dateObj.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
                // ä½¿ç”¨ toLocaleDateString ç¢ºä¿æ ¼å¼æ­£ç¢ºï¼Œä¸¦å°‡åˆ†éš”ç¬¦æ›¿æ›ç‚º /
                const finalDisplay = formattedDate.replace(/å¹´|æœˆ/g, '/').replace(/æ—¥/g, ''); 
                document.getElementById('current-date-text').textContent = finalDisplay; 
            } catch(e) {
                document.getElementById('current-date-text').textContent = d.date; 
            }
            document.getElementById('current-location-text').textContent=d.location||"LOCATION"; 
        } else {
            document.getElementById('current-date-text').textContent = '----/--/--';
            document.getElementById('current-location-text').textContent = 'LOCATION';
        }
    }
    
    /* LISTS & EXPENSES LOGIC */
    // è³¼ç‰©æ¸…å–®/è¡Œææ¸…å–®é …ç›®æ¸²æŸ“æ™‚ï¼Œä¹ŸåŠ å…¥æ»¾å‹•æ¼¸å…¥å‹•ç•«
    function renderListsPage() {
        const checkTab = document.getElementById('sub-tab-checklist');
        const shopTab = document.getElementById('sub-tab-shopping');
        const checkCont = document.getElementById('container-checklist');
        const shopCont = document.getElementById('container-shopping');
        
        if (observer) observer.disconnect(); // æ–·é–‹ IO é€£çµ

        if (currentListTab === 'checklist') { 
            checkTab.className = 'w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-active text-sm'; 
            shopTab.className = 'w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-inactive text-sm'; 
            checkCont.classList.remove('hidden'); 
            shopCont.classList.add('hidden'); 
            renderChecklist(); 
        } 
        else { 
            checkTab.className = 'w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-inactive text-sm'; 
            shopTab.className = 'w-1/2 text-center py-2 rounded-lg transition-all cursor-pointer sub-tab-active text-sm'; 
            checkCont.classList.add('hidden'); 
            shopCont.classList.remove('hidden'); 
            renderShopping(); 
        }
    }
    function switchListSubTab(tab) { currentListTab = tab; renderListsPage(); }
    
    // æ ¸å¿ƒ: æ¸…å–®é …ç›®ä¹ŸåŠ å…¥æ»¾å‹•æ¼¸å…¥å‹•ç•«
    function renderChecklist() { 
        const container=document.getElementById('checklist-items'); 
        container.innerHTML=''; 
        let localIndex = 0;
        tripData.checklist.forEach((item, idx)=>{ 
            const el=document.createElement('div'); 
            el.className="flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-100 timeline-card"; /* å€Ÿç”¨ timeline-card æ¨£å¼ */
            el.dataset.globalIndex = localIndex++;
            el.innerHTML=`<input type="checkbox" ${item.checked?'checked':''} onchange="toggleCheckItem(${idx})" class="custom-checkbox"><input type="text" value="${item.text}" onchange="updateCheckItem(${idx},this.value)" class="flex-1 text-sm ${item.checked?'line-through text-gray-400':'text-ink'} bg-transparent border-none p-0 focus:ring-0"><button onclick="deleteCheckItem(${idx})" class="text-gray-300 hover:text-rose-400">âœ•</button>`; 
            container.appendChild(el); 
            // é‡æ–°é€£æ¥ IO
            if (observer) observer.observe(el);
        }); 
        // åœ¨ IO æ–·é–‹å¾Œï¼Œæ‰‹å‹•è§¸ç™¼ä¸€æ¬¡é¡¯ç¤ºï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œé¿å…é‡è¤‡è¨­ç½® observerï¼‰
        if (!isInitialLoad && observer) setupIntersectionObserver();
    }
    
    function applyChecklist(d) { if(window.confirm(`åŒ¯å…¥ ${d} å¤©æ¸…å–®ï¼Ÿ`)){ CHECKLIST_PRESETS[d].forEach(p=>{if(!tripData.checklist.some(i=>i.text===p))tripData.checklist.push({text:p,checked:false})}); renderChecklist(); saveCurrentTrip(); showToast("å·²å¥—ç”¨é è¨­æ¸…å–®"); } }
    function addChecklistItem() { const inp=document.getElementById('new-item-input'); if(inp.value.trim()){ tripData.checklist.push({text:inp.value.trim(),checked:false}); inp.value=''; renderChecklist(); saveCurrentTrip(); showToast("å·²æ–°å¢è¡Œæé …ç›®"); } }
    function toggleCheckItem(i){tripData.checklist[i].checked=!tripData.checklist[i].checked; renderChecklist(); saveCurrentTrip();}
    function updateCheckItem(i,v){tripData.checklist[i].text=v; saveCurrentTrip();}
    function deleteCheckItem(i){tripData.checklist.splice(i,1); renderChecklist(); saveCurrentTrip(); showToast("å·²åˆªé™¤è¡Œæé …ç›®");}
    
    // æ ¸å¿ƒ: è³¼ç‰©æ¸…å–®ä¹ŸåŠ å…¥æ»¾å‹•æ¼¸å…¥å‹•ç•«
    function renderShopping() { 
        const container=document.getElementById('shopping-items'); 
        container.innerHTML=''; 
        let localIndex = 0;
        tripData.shoppingList.forEach((item, idx)=>{ 
            const el=document.createElement('div'); 
            el.className="flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-100 timeline-card"; /* å€Ÿç”¨ timeline-card æ¨£å¼ */
            el.dataset.globalIndex = localIndex++;
            el.innerHTML=`<input type="checkbox" ${item.checked?'checked':''} onchange="toggleShopItem(${idx})" class="custom-checkbox"><input type="text" value="${item.text}" onchange="updateShopItem(${idx},this.value)" class="flex-1 text-sm ${item.checked?'line-through text-gray-400':'text-ink'} bg-transparent border-none p-0 focus:ring-0"><button onclick="deleteShopItem(${idx})" class="text-gray-300 hover:text-rose-400">âœ•</button>`; 
            container.appendChild(el); 
            if (observer) observer.observe(el);
        }); 
        if (!isInitialLoad && observer) setupIntersectionObserver();
    }
    function addShoppingItem() { const inp=document.getElementById('new-shop-input'); if(inp.value.trim()){ tripData.shoppingList.push({text:inp.value.trim(),checked:false}); inp.value=''; renderShopping(); saveCurrentTrip(); showToast("å·²æ–°å¢è³¼ç‰©é …ç›®"); } }
    function toggleShopItem(i){tripData.shoppingList[i].checked=!tripData.shoppingList[i].checked; renderShopping(); saveCurrentTrip();}
    function updateShopItem(i,v){tripData.shoppingList[i].text=v; saveCurrentTrip();}
    function deleteShopItem(i){tripData.shoppingList.splice(i,1); renderShopping(); saveCurrentTrip(); showToast("å·²åˆªé™¤è³¼ç‰©é …ç›®");}

    function initExpenseForm() {
        const payerSel = document.getElementById('exp-payer'); 
        const beneSel = document.getElementById('exp-beneficiary');
        payerSel.innerHTML = '';
        beneSel.innerHTML = '';
        
        // Payer list (Normal travelers)
        tripData.travelers.forEach(t => { 
            const optP = document.createElement('option'); optP.value = t; optP.textContent = t; payerSel.appendChild(optP);
        });
        
        // Beneficiary list (Travelers + "å‡æ”¤")
        tripData.travelers.forEach(t => { 
            const optB = document.createElement('option'); optB.value = t; optB.textContent = t; beneSel.appendChild(optB);
        });
        // Append "å‡æ”¤" option
        const optAvg = document.createElement('option'); optAvg.value = 'å‡æ”¤'; optAvg.textContent = 'å‡æ”¤ (æ‰€æœ‰äººå¹³åˆ†)'; beneSel.appendChild(optAvg);
        
        document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('exp-name').value = '';
        document.getElementById('exp-detail').value = '';
        document.getElementById('exp-amount').value = '';
        document.getElementById('exp-twd-preview').textContent = 'â‰ˆ NT$ 0';
        
        const baseCurr = tripData.baseCurrency || 'JPY';
        const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;
        const curSel = document.getElementById('exp-currency'); curSel.innerHTML = `<option value="${baseCurr}">${baseSymbol}</option><option value="TWD">NT$</option>`;
        curSel.value = baseCurr;
    }
    
    function syncBeneficiary(val) {
        // è²»ç”¨é é¢çš„é€£å‹•é‚è¼¯
        const beneSel = document.getElementById('exp-beneficiary');
        if(beneSel) beneSel.value = val;
    }

    function calcExpTWD(val) {
        const rate = tripData.exchangeRate;
        const cur = document.getElementById('exp-currency') ? document.getElementById('exp-currency').value : (tripData.baseCurrency||'JPY');
        let twd = 0;
        if(cur === 'TWD') twd = parseInt(val)||0;
        else twd = Math.round((parseInt(val)||0) * rate);
        document.getElementById('exp-twd-preview').textContent = `â‰ˆ NT$ ${twd.toLocaleString()}`;
    }
    function addExpenseItem() {
        const date = document.getElementById('exp-date').value;
        const cat = document.getElementById('exp-category').value;
        const name = document.getElementById('exp-name').value;
        const detail = document.getElementById('exp-detail').value;
        const payer = document.getElementById('exp-payer').value;
        const beneficiary = document.getElementById('exp-beneficiary').value;
        const amount = parseInt(document.getElementById('exp-amount').value) || 0;
        const currency = document.getElementById('exp-currency').value;
        if(!date || !name || amount <= 0) { showToast("è«‹å¡«å¯«å®Œæ•´æ—¥æœŸã€åç¨±èˆ‡é‡‘é¡"); return; }
        // å„²å­˜ beneficiary è³‡è¨Šï¼Œè‹¥ç„¡å‰‡é è¨­ç‚º payer 
        const expenseObj = { date, category: cat, name, detail, payer, beneficiary: beneficiary || payer, amount, currency };
        tripData.expenses.push(expenseObj);
        saveCurrentTrip();
        renderExpensesList();
        initExpenseForm();
        showToast(`å·²æ–°å¢è²»ç”¨: ${name}`);
    }
    function toggleEditExpense(idx) {
        const container = document.getElementById('expenses-list-container');
        const items = container.children;
        for (let i=0; i<items.length; i++) {
            if (i !== idx) {
                const otherView = items[i].querySelector('.view-mode');
                const otherEdit = items[i].querySelector('.edit-mode');
                if(otherView && otherEdit) { otherView.classList.remove('hidden'); otherEdit.classList.add('hidden'); }
            }
        }
        const target = items[idx];
        const viewMode = target.querySelector('.view-mode');
        const editMode = target.querySelector('.edit-mode');
        if(viewMode.classList.contains('hidden')) { viewMode.classList.remove('hidden'); editMode.classList.add('hidden'); } else { 
            const exp = tripData.expenses[idx]; 
            target.querySelector('.edit-date').value = exp.date; 
            target.querySelector('.edit-category').value = exp.category; 
            target.querySelector('.edit-name').value = exp.name; 
            target.querySelector('.edit-detail').value = exp.detail || ''; 
            
            const payerSel = target.querySelector('.edit-payer'); 
            const beneSel = target.querySelector('.edit-beneficiary');
            payerSel.innerHTML = ''; beneSel.innerHTML = '';
            
            tripData.travelers.forEach(t => { 
                const optP = document.createElement('option'); optP.value = t; optP.textContent = t; if(t === exp.payer) optP.selected = true; payerSel.appendChild(optP);
                const optB = document.createElement('option'); optB.value = t; optB.textContent = t; if(t === (exp.beneficiary || exp.payer)) optB.selected = true; beneSel.appendChild(optB);
            }); 
            // Append "å‡æ”¤" option to edit dropdown
            const optAvg = document.createElement('option'); optAvg.value = 'å‡æ”¤'; optAvg.textContent = 'å‡æ”¤ (æ‰€æœ‰äººå¹³åˆ†)'; 
            if(exp.beneficiary === 'å‡æ”¤') optAvg.selected = true;
            beneSel.appendChild(optAvg);
            
            const baseCurr = tripData.baseCurrency || 'JPY';
            const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;
            const curSel = target.querySelector('.edit-currency-select');
            curSel.innerHTML = `<option value="${baseCurr}">${baseSymbol}</option><option value="TWD">NT$</option>`;
            curSel.value = exp.currency || baseCurr;
            
            target.querySelector('.edit-amount').value = exp.amount; 
            viewMode.classList.add('hidden'); editMode.classList.remove('hidden'); 
        }
    }
    function saveInlineExpense(idx) {
        const target = document.getElementById('expenses-list-container').children[idx];
        const date = target.querySelector('.edit-date').value;
        const cat = target.querySelector('.edit-category').value;
        const name = target.querySelector('.edit-name').value;
        const detail = target.querySelector('.edit-detail').value;
        const payer = target.querySelector('.edit-payer').value;
        const beneficiary = target.querySelector('.edit-beneficiary').value;
        const amount = parseInt(target.querySelector('.edit-amount').value) || 0;
        const currency = target.querySelector('.edit-currency-select').value;
        if(!date || !name || amount <= 0) { showToast("è«‹å¡«å¯«å®Œæ•´è³‡æ–™"); return; }
        tripData.expenses[idx] = { date, category: cat, name, detail, payer, beneficiary, amount, currency };
        saveCurrentTrip();
        renderExpensesList();
        showToast(`è²»ç”¨å·²å„²å­˜: ${name}`);
    }
    function deleteExpenseItem(idx) { 
        if(window.confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è²»ç”¨ï¼Ÿ")) { 
            const deleted = tripData.expenses.splice(idx, 1); 
            saveCurrentTrip(); 
            renderExpensesList(); 
            if (deleted.length > 0) {
                showToast(`å·²åˆªé™¤è²»ç”¨: ${deleted[0].name || 'æœªå‘½åè²»ç”¨'}`);
            }
        } 
    }
    
    // Render Expense List with Drag Handles
    // æ ¸å¿ƒ: è²»ç”¨åˆ—è¡¨ä¹ŸåŠ å…¥æ»¾å‹•æ¼¸å…¥å‹•ç•«
    function renderExpensesList() {
        const c = document.getElementById('expenses-list-container');
        c.innerHTML = '';
        const baseCurr = tripData.baseCurrency || 'JPY';
        const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;
        const rate = tripData.exchangeRate || 0.215;

        // åœæ­¢èˆŠçš„è§€å¯Ÿè€…
        if (observer) {
            observer.disconnect();
        }

        let localIndex = 0;
        tripData.expenses.forEach((exp, idx) => {
            const isTwd = exp.currency === 'TWD';
            const displaySymbol = isTwd ? 'NT$' : baseSymbol;
            let twd = 0;
            if(isTwd) twd = exp.amount;
            else twd = Math.round(exp.amount * rate);
            
            // è™•ç†å—ç›Šäººé¡¯ç¤ºæ–‡å­—
            const bene = exp.beneficiary || exp.payer;
            let relationText = '';
            if (bene === 'å‡æ”¤') {
                relationText = `${exp.payer} â®• å…¨å“¡å‡æ”¤`;
            } else {
                const isForSelf = bene === exp.payer;
                relationText = isForSelf ? `${exp.payer}` : `${exp.payer} â®• ${bene}`;
            }

            const icon = getCategoryIcon(exp.category);
            const el = document.createElement('div');
            // æ ¸å¿ƒ: åŠ å…¥ timeline-card classï¼Œä¸¦æ‰‹å‹•è¨­ç½®å»¶é²
            el.className = "bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden drag-item group timeline-card";
            el.dataset.index = idx;
            el.dataset.globalIndex = localIndex++;

            // Drag event bindings (same as itinerary)
            el.addEventListener('dragstart', handleSortableDragStart); 
            el.addEventListener('dragover', handleSortableDragOver); 
            el.addEventListener('drop', handleExpenseDrop); 
            el.addEventListener('touchstart', handleSortableTouchStart, {passive: false});
            el.addEventListener('touchmove', handleExpenseTouchMove, {passive: false});
            el.addEventListener('touchend', handleSortableTouchEnd);
            
            const dragHandleHtml = `<div class="drag-handle-btn cursor-grab active:cursor-grabbing p-4 text-gray-300 hover:text-[var(--theme-color)] flex items-center justify-center transition border-l border-gray-50 h-full" title="æ‹–æ›³æ’åº" draggable="true"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>`;

            el.innerHTML = `
                <div class="view-mode flex items-stretch">
                     <div class="flex-1 p-4 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-xl shadow-inner flex-shrink-0">${icon}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0 mr-2"><h4 class="font-bold text-ink truncate">${exp.name}</h4>${exp.detail ? `<div class="text-xs text-gray-400 truncate mt-0.5">${exp.detail}</div>` : ''}</div>
                                <span class="text-lg font-bold text-[var(--theme-color)] font-serif whitespace-nowrap">${displaySymbol}${exp.amount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-50">
                                <div class="flex gap-2"><span>${exp.date}</span><span>â€¢</span><span class="font-bold text-gray-500">${relationText}</span></div>
                                <span>â‰ˆ NT$ ${twd.toLocaleString()}</span>
                            </div>
                        </div>
                     </div>
                     <div class="flex flex-col border-l border-gray-50">
                        <button onclick="event.stopPropagation(); toggleEditExpense(${idx})" class="flex-1 px-3 text-gray-300 hover:text-[var(--theme-color)] hover:bg-gray-50 transition border-b border-gray-50" title="ç·¨è¼¯">âœ</button>
                        <button onclick="event.stopPropagation(); deleteExpenseItem(${idx})" class="flex-1 px-3 text-gray-300 hover:text-rose-400 hover:bg-rose-50 transition" title="åˆªé™¤">âœ•</button>
                     </div>
                     ${dragHandleHtml}
                </div>
                <div class="edit-mode hidden bg-gray-50 p-4 border-t border-gray-100">
                    <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="input-label">æ—¥æœŸ</label><input type="date" class="edit-date edit-modal-input text-xs bg-white px-2 rounded border-none w-full"></div><div><label class="input-label">é¡åˆ¥</label><select class="edit-category edit-modal-input text-xs font-bold bg-white px-2 rounded border-none w-full"><option value="é£Ÿ">ğŸš é£Ÿ</option><option value="è¡£">ğŸ‘• è¡£</option><option value="ä½">ğŸ¨ ä½</option><option value="è¡Œ">ğŸš† è¡Œ</option><option value="è‚²">ğŸ« è‚²</option><option value="æ¨‚">ğŸ¡ æ¨‚</option><option value="è³¼">ğŸ›ï¸ è³¼</option><option value="é›œ">ğŸ”§ é›œ</option></select></div></div>
                    <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="input-label">é …ç›®åç¨±</label><input type="text" class="edit-name edit-modal-input text-xs bg-white px-2 rounded border-none w-full" placeholder="é …ç›®åç¨±"></div><div><label class="input-label">ä»˜æ¬¾äºº</label><select class="edit-payer edit-modal-input text-xs bg-white px-2 rounded border-none w-full"></select></div></div>
                    <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="input-label">å¹«èª°ä»˜</label><select class="edit-beneficiary edit-modal-input text-xs bg-white px-2 rounded border-none w-full"></select></div><div></div></div>
                    <div class="mb-3"><label class="input-label">ç´°é …å‚™è¨»</label><input type="text" class="edit-detail edit-modal-input text-xs bg-white px-2 rounded border-none w-full" placeholder="ç´°é …å‚™è¨»"></div>
                    <div class="flex items-center gap-2 mb-4">
                        <select class="edit-currency-select text-xs font-bold bg-white px-2 py-1 rounded border-none"></select>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" class="edit-amount flex-1 border-b border-gray-300 text-sm font-bold bg-transparent py-1">
                    </div>
                    <div class="flex gap-2"><button onclick="saveInlineExpense(${idx})" class="flex-1 py-2 bg-[var(--theme-color)] text-white text-xs rounded shadow">ğŸ’¾ å„²å­˜</button><button onclick="toggleEditExpense(${idx})" class="px-3 py-2 bg-gray-200 text-gray-600 text-xs rounded shadow">â†© å–æ¶ˆ</button></div>
                </div>`;
            c.appendChild(el);
            if (observer) observer.observe(el);
        });
        if (!isInitialLoad && observer) setupIntersectionObserver();
        updateBudgetSummary();
    }
    
    // Shared Drag Logic
    let draggedItemIdx = null; 
    let touchStartY = 0; 
    let touchTargetItem = null;

    function handleSortableDragStart(e) { 
        if (!e.target.closest('.drag-handle-btn')) { e.preventDefault(); return; }
        draggedItemIdx = +this.closest('.drag-item').dataset.index; 
        this.closest('.drag-item').classList.add('dragging'); 
        e.dataTransfer.effectAllowed = 'move'; 
    }
    function handleSortableDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
    function handleSortableTouchStart(e) { 
        if (e.target.closest('input, textarea, select, button, a')) return;
        if (!e.target.closest('.drag-handle-btn')) return;
        touchTargetItem = e.target.closest('.drag-item'); 
        if (!touchTargetItem) return;
        e.preventDefault(); 
        draggedItemIdx = +touchTargetItem.dataset.index;
        touchStartY = e.touches[0].clientY;
        touchTargetItem.classList.add('dragging');
    }
    function handleSortableTouchEnd(e) { 
        if(!touchTargetItem) return; 
        touchTargetItem.classList.remove('dragging'); 
        touchTargetItem = null; draggedItemIdx = null;
    }

    // Itinerary Drop/Move
    function handleActivityDrop(e) { 
        e.preventDefault(); 
        const target = e.target.closest('.drag-item'); 
        if (target && draggedItemIdx !== null) { 
            const droppedIdx = +target.dataset.index; 
            if(draggedItemIdx !== droppedIdx) { 
                const activities = tripData.days[`Day ${currentDay}`].activities;
                const item = activities.splice(draggedItemIdx, 1)[0]; 
                activities.splice(droppedIdx, 0, item); 
                // æ³¨æ„ï¼šé€™è£¡åªåŸ·è¡Œæ‹–æ›³æ›ä½ï¼Œä¸åŸ·è¡Œæ™‚é–“æ’åº
                saveCurrentTrip(); renderTimeline(true); 
            } 
        } 
        document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
        draggedItemIdx = null; 
    }
    function handleActivityTouchMove(e) { 
        if(!touchTargetItem) return; e.preventDefault();
        const container = document.getElementById('timeline-container');
        const mouseY = e.touches[0].clientY;
        const elements = Array.from(container.children).filter(el => el.classList.contains('drag-item'));
        let hoverIndex = -1;
        elements.forEach((el, index) => {
            const rect = el.getBoundingClientRect();
            if (mouseY > rect.top && mouseY < rect.bottom && index !== draggedItemIdx) {
                hoverIndex = (mouseY > rect.top + rect.height / 2) ? index + 1 : index;
            }
        });
        if (hoverIndex !== -1 && hoverIndex !== draggedItemIdx && hoverIndex !== draggedItemIdx + 1) {
            const activities = tripData.days[`Day ${currentDay}`].activities;
            const item = activities.splice(draggedItemIdx, 1)[0];
            activities.splice(hoverIndex - (hoverIndex > draggedItemIdx ? 1 : 0), 0, item);
            draggedItemIdx = hoverIndex - (hoverIndex > draggedItemIdx ? 1 : 0);
            saveCurrentTrip(); renderTimeline(true); 
            const reRenderedItem = document.querySelector(`div[data-index="${draggedItemIdx}"]`);
            if (reRenderedItem) { touchTargetItem = reRenderedItem; touchTargetItem.classList.add('dragging'); }
        }
    }

    // Expense Drop/Move
    function handleExpenseDrop(e) {
        e.preventDefault();
        const target = e.target.closest('.drag-item');
        if (target && draggedItemIdx !== null) {
            const droppedIdx = +target.dataset.index;
            if(draggedItemIdx !== droppedIdx) {
                const item = tripData.expenses.splice(draggedItemIdx, 1)[0];
                tripData.expenses.splice(droppedIdx, 0, item);
                saveCurrentTrip(); renderExpensesList();
            }
        }
        document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
        draggedItemIdx = null;
    }
    function handleExpenseTouchMove(e) {
        if(!touchTargetItem) return; e.preventDefault();
        const container = document.getElementById('expenses-list-container');
        const mouseY = e.touches[0].clientY;
        const elements = Array.from(container.children).filter(el => el.classList.contains('drag-item'));
        let hoverIndex = -1;
        elements.forEach((el, index) => {
            const rect = el.getBoundingClientRect();
            if (mouseY > rect.top && mouseY < rect.bottom && index !== draggedItemIdx) {
                hoverIndex = (mouseY > rect.top + rect.height / 2) ? index + 1 : index;
            }
        });
        if (hoverIndex !== -1 && hoverIndex !== draggedItemIdx && hoverIndex !== draggedItemIdx + 1) {
            const item = tripData.expenses.splice(draggedItemIdx, 1)[0];
            tripData.expenses.splice(hoverIndex - (hoverIndex > draggedItemIdx ? 1 : 0), 0, item);
            draggedItemIdx = hoverIndex - (hoverIndex > draggedItemIdx ? 1 : 0);
            saveCurrentTrip(); renderExpensesList();
            const reRenderedItem = container.querySelector(`div[data-index="${draggedItemIdx}"]`);
            if (reRenderedItem) { touchTargetItem = reRenderedItem; touchTargetItem.classList.add('dragging'); }
        }
    }
    
    /* CHART LOGIC */
    function toggleChartMode() {
        currentChartMode = currentChartMode === 'payment' ? 'consumption' : 'payment';
        const slider = document.getElementById('chart-mode-slider');
        const btnPay = document.getElementById('btn-mode-payment');
        const btnCons = document.getElementById('btn-mode-consumption');
        
        if (currentChartMode === 'payment') {
            slider.style.transform = 'translateX(0)';
            btnPay.classList.replace('inactive', 'active');
            btnCons.classList.replace('active', 'inactive');
            document.getElementById('chart-pie-title').textContent = 'äººå“¡å…ˆä»˜æ˜ç´° (ç¾é‡‘æµå‡º)';
            document.getElementById('chart-bar-title').textContent = 'æ¯äººå…ˆä»˜å„é¡èŠ±è²»';
        } else {
            slider.style.transform = 'translateX(100%)';
            btnPay.classList.replace('active', 'inactive');
            btnCons.classList.replace('inactive', 'active');
            document.getElementById('chart-pie-title').textContent = 'äººå“¡æ¶ˆè²»æ˜ç´° (å¯¦éš›æ­¸å±¬)';
            document.getElementById('chart-bar-title').textContent = 'æ¯äººå¯¦éš›å„é¡èŠ±è²»';
        }
        renderChartPage();
    }
    
    // Settlement Calculation (Greedy Algorithm)
    function calculateSettlements(balances, rate, symbol) {
        // Separate Debtors (Negative) and Creditors (Positive)
        let debtors = [];
        let creditors = [];

        for (const [person, amount] of Object.entries(balances)) {
            if (amount < -1) debtors.push({ person, amount }); // Tolerance for float errors
            else if (amount > 1) creditors.push({ person, amount });
        }

        // Sort by magnitude desc (Greedy)
        debtors.sort((a, b) => a.amount - b.amount); // Most negative first
        creditors.sort((a, b) => b.amount - a.amount); // Most positive first

        let transactions = [];
        let i = 0; // debtor index
        let j = 0; // creditor index

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];

            // The amount to settle is the minimum of what debtor owes and creditor needs
            let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
            
            // Round for display clarity
            let displayAmount = Math.round(amount);
            let displayTwd = Math.round(amount * rate);

            if (amount > 0) {
                transactions.push({
                    from: debtor.person,
                    to: creditor.person,
                    amount: displayAmount,
                    twd: displayTwd
                });
            }

            // Adjust remaining balances
            debtor.amount += amount;
            creditor.amount -= amount;

            // Move indices if settled
            if (Math.abs(debtor.amount) < 1) i++;
            if (creditor.amount < 1) j++;
        }

        return transactions;
    }

    function updateBudgetSummary() {
        let total = 0;
        window.payerBreakdown = {};
        window.consumptionBreakdown = {}; 
        window.personCategoryBreakdown = {}; 
        
        // åˆ†åˆ¥å»ºç«‹å…©ä»½æ¸…å–®ï¼šä¸€ä»½çµ¦ä»˜æ¬¾æ¨¡å¼ï¼Œä¸€ä»½çµ¦æ¶ˆè²»æ¨¡å¼
        window.categoryListPayment = {};
        window.categoryListConsumption = {};
        ['é£Ÿ','è¡£','ä½','è¡Œ','è‚²','æ¨‚','è³¼','é›œ'].forEach(cat => {
            window.categoryListPayment[cat] = {total: 0, items: []};
            window.categoryListConsumption[cat] = {total: 0, items: []};
        });
        
        // For Settlement Calculation
        window.netBalances = {}; // Globalize for export
        tripData.travelers.forEach(t => { 
            window.netBalances[t] = 0;
            window.payerBreakdown[t] = 0;
            window.consumptionBreakdown[t] = 0;
            window.personCategoryBreakdown[t] = {}; 
            ['é£Ÿ','è¡£','ä½','è¡Œ','è‚²','æ¨‚','è³¼','é›œ'].forEach(cat => window.personCategoryBreakdown[t][cat] = 0); 
        });

        const baseCurr = tripData.baseCurrency || 'JPY';
        const rate = tripData.exchangeRate;
        const totalTravelers = tripData.travelers.length; // Count for splitting

        const normalize = (amount, sourceCurrency) => {
            if (sourceCurrency === baseCurr) return amount;
            if (sourceCurrency === 'TWD') return Math.round(amount / rate);
            return amount;
        };
        
        // 1. Itinerary Costs
        Object.values(tripData.days).forEach(d=>d.activities?.forEach(a=>{
            if(a.splits && Array.isArray(a.splits)) {
                const type = a.costType || 'é›œ';
                const sourceCurr = a.currency || baseCurr;
                
                a.splits.forEach(splitItem => {
                    // Use new structure: beneficiary and payer
                    const beneficiary = splitItem.beneficiary || tripData.travelers[0];
                    const payer = splitItem.payer || tripData.travelers[0];
                    const val = parseInt(splitItem.amount) || 0;
                    
                    if(val > 0) {
                        const normalizedVal = normalize(val, sourceCurr);
                        total += normalizedVal;
                        
                        // 1. ä»˜æ¬¾æ¨¡å¼æ¸…å–® (Payment List Logic)
                        // ç„¡è«– beneficiaries æ˜¯èª°ï¼Œåªè¦æ˜¯é€™å€‹ payer ä»˜çš„éŒ¢ï¼Œå°±åŠ ç¸½é€²å»ã€‚ä¸æ‹†åˆ†ã€‚
                        window.payerBreakdown[payer] = (window.payerBreakdown[payer]||0) + normalizedVal;
                        window.netBalances[payer] = (window.netBalances[payer] || 0) + normalizedVal;
                        
                        window.categoryListPayment[type].total += normalizedVal;
                        window.categoryListPayment[type].items.push({ 
                            name: a.location, 
                            detail: a.expenseDetail || '', 
                            amount: normalizedVal, 
                            payer: payer, 
                            beneficiary: beneficiary, 
                            date: d.date,
                            isItinerary: true,
                            viewMode: 'payment'
                        });

                        // 2. æ¶ˆè²»æ¨¡å¼æ¸…å–® (Consumption List Logic) - è™•ç†å‡æ”¤æ‹†åˆ†
                        if (beneficiary === 'å‡æ”¤') {
                            const splitAmount = normalizedVal / totalTravelers;
                            tripData.travelers.forEach(t => {
                                // Consumption Stats
                                window.consumptionBreakdown[t] = (window.consumptionBreakdown[t]||0) + splitAmount;
                                window.personCategoryBreakdown[t][type] = (window.personCategoryBreakdown[t][type] || 0) + splitAmount;
                                window.netBalances[t] = (window.netBalances[t] || 0) - splitAmount;

                                // Add INDIVIDUAL split item to Consumption List
                                window.categoryListConsumption[type].total += splitAmount;
                                window.categoryListConsumption[type].items.push({ 
                                    name: a.location, 
                                    detail: a.expenseDetail || '', 
                                    amount: splitAmount, 
                                    payer: payer, 
                                    beneficiary: t, 
                                    date: d.date,
                                    isItinerary: true,
                                    isShared: true, // Flag for display text
                                    viewMode: 'consumption'
                                });
                            });
                        } else {
                            // Standard 1-to-1
                            window.consumptionBreakdown[beneficiary] = (window.consumptionBreakdown[beneficiary]||0) + normalizedVal;
                            window.personCategoryBreakdown[beneficiary][type] = (window.personCategoryBreakdown[beneficiary][type] || 0) + normalizedVal;
                            window.netBalances[beneficiary] = (window.netBalances[beneficiary] || 0) - normalizedVal;

                            window.categoryListConsumption[type].total += normalizedVal;
                            window.categoryListConsumption[type].items.push({ 
                                name: a.location, 
                                detail: a.expenseDetail || '', 
                                amount: normalizedVal, 
                                payer: payer, 
                                beneficiary: beneficiary, 
                                date: d.date,
                                isItinerary: true,
                                viewMode: 'consumption'
                            });
                        }
                    }
                });
            }
        }));
        
        // 2. Expenses List Costs
        tripData.expenses.forEach(exp => {
            const val = parseInt(exp.amount) || 0;
            const payer = exp.payer;
            const beneficiary = exp.beneficiary || exp.payer; // Ensure beneficiary is set
            
            if (val > 0 && payer) {
                const sourceCurr = exp.currency || baseCurr;
                const normalizedVal = normalize(val, sourceCurr);
                const type = exp.category;
                
                total += normalizedVal; 

                // 1. ä»˜æ¬¾æ¨¡å¼æ¸…å–® (Payment List Logic)
                window.payerBreakdown[payer] = (window.payerBreakdown[payer]||0) + normalizedVal;
                window.netBalances[payer] = (window.netBalances[payer] || 0) + normalizedVal;

                window.categoryListPayment[type].total += normalizedVal;
                window.categoryListPayment[type].items.push({ 
                    name: exp.name, 
                    detail: exp.detail || '', 
                    amount: normalizedVal, 
                    payer: payer, 
                    beneficiary: beneficiary,
                    date: exp.date,
                    isItinerary: false,
                    viewMode: 'payment'
                });

                // 2. æ¶ˆè²»æ¨¡å¼æ¸…å–® (Consumption List Logic)
                if (beneficiary === 'å‡æ”¤') {
                    const splitAmount = normalizedVal / totalTravelers;
                    tripData.travelers.forEach(t => {
                        window.consumptionBreakdown[t] = (window.consumptionBreakdown[t]||0) + splitAmount;
                        window.personCategoryBreakdown[t][type] = (window.personCategoryBreakdown[t][type] || 0) + splitAmount;
                        window.netBalances[t] = (window.netBalances[t] || 0) - splitAmount;

                        window.categoryListConsumption[type].total += splitAmount;
                        window.categoryListConsumption[type].items.push({ 
                            name: exp.name, 
                            detail: exp.detail || '', 
                            amount: splitAmount, 
                            payer: payer, 
                            beneficiary: t,
                            date: exp.date,
                            isItinerary: false,
                            isShared: true,
                            viewMode: 'consumption'
                        });
                    });
                } else {
                    window.consumptionBreakdown[beneficiary] = (window.consumptionBreakdown[beneficiary]||0) + normalizedVal;
                    window.personCategoryBreakdown[beneficiary][type] = (window.personCategoryBreakdown[beneficiary][type] || 0) + normalizedVal;
                    window.netBalances[beneficiary] = (window.netBalances[beneficiary] || 0) - normalizedVal;

                    window.categoryListConsumption[type].total += normalizedVal;
                    window.categoryListConsumption[type].items.push({ 
                        name: exp.name, 
                        detail: exp.detail || '', 
                        amount: normalizedVal, 
                        payer: payer, 
                        beneficiary: beneficiary,
                        date: exp.date,
                        isItinerary: false,
                        viewMode: 'consumption'
                    });
                }
            }
        });
        
        // Prepare final breakdown data for traveler header
        const isPaymentMode = currentChartMode === 'payment';
        const finalTravelerBreakdown = isPaymentMode ? window.payerBreakdown : window.consumptionBreakdown;

        const headerTotalBase = document.getElementById('header-total-base');
        const headerTotalTarget = document.getElementById('header-total-target');
        const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;

        headerTotalBase.textContent = `${baseSymbol} ${total.toLocaleString()}`;
        headerTotalTarget.textContent = `â‰ˆ NT$ ${Math.round(total * rate).toLocaleString()}`;
        
        const breakdownEl = document.getElementById('travelers-breakdown');
        breakdownEl.innerHTML = '';
        tripData.travelers.forEach((p, idx) => {
            let amt = finalTravelerBreakdown[p] || 0;
            let displayAmt = `${baseSymbol}${amt.toLocaleString()}`;
            const color = generateThemePalette(tripData.themeColor, idx, tripData.travelers.length);
            // æ ¸å¿ƒï¼šåœ¨ traveller breakdown è† å›Šä¸Šä¹ŸåŠ å…¥å½ˆç°§æ›²ç·š
            breakdownEl.innerHTML += `<div class="flex items-center flex-shrink-0 bg-white rounded-full pr-3 py-1 border border-gray-100 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-[1.03]" style="transition-timing-function: var(--spring-curve);"><div class="avatar-circle mr-2" style="width:32px;height:32px;font-size:12px;background-color:${color};border-color:${color}">${p.substring(0,1)}</div><span class="text-xs text-gray-700 font-bold">${displayAmt}</span></div>`;
        });
        
        // --- Render Settlement Plan (Updated with New UI) ---
        const settlementList = document.getElementById('settlement-list');
        settlementList.innerHTML = '';
        const settlements = calculateSettlements(window.netBalances, rate, baseSymbol);
        window.calculatedSettlements = settlements; // Globalize for export
        
        if (settlements.length === 0) {
            settlementList.innerHTML = '<div class="text-center text-gray-400 text-xs py-4 bg-gray-50 rounded-xl">ğŸ‰ ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³</div>';
        } else {
            settlementList.innerHTML = '';
            settlements.forEach(tx => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between py-1 border-b border-gray-100 last:border-b-0';
                
                // å–å¾—é ­åƒé¡è‰²
                const fromIdx = tripData.travelers.indexOf(tx.from);
                const toIdx = tripData.travelers.indexOf(tx.to);
                const fromColor = fromIdx >= 0 ? generateThemePalette(tripData.themeColor, fromIdx, tripData.travelers.length) : '#94a3b8'; // Default grey
                const toColor = toIdx >= 0 ? generateThemePalette(tripData.themeColor, toIdx, tripData.travelers.length) : '#94a3b8'; // Default grey

                el.innerHTML = `
                    <div class="info-pill">
                      <div class="circle-avatar-new" style="background-color:${fromColor}">${tx.from.substring(0,1)}</div>
                      <div class="pill-text">${tx.from}</div>
                    </div>

                    <div class="transfer-middle">
                      <span class="action-label-settlement">çµ¦äºˆ</span>
                      <div class="arrow-wrapper text-[var(--theme-color)] w-full flex justify-center">
                        <svg class="long-arrow-settlement" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M4 12H20M20 12L14 6M20 12L14 18" />
                        </svg>
                      </div>
                      <div class="flex flex-col items-center mt-[-4px]">
                        <span class="font-bold text-[var(--theme-color)] text-sm leading-none">${baseSymbol} ${tx.amount.toLocaleString()}</span>
                        <span class="text-[9px] text-gray-400 scale-90">â‰ˆ NT$ ${tx.twd.toLocaleString()}</span>
                      </div>
                    </div>

                    <div class="info-pill">
                      <div class="circle-avatar-new" style="background-color:${toColor}">${tx.to.substring(0,1)}</div>
                      <div class="pill-text">${tx.to}</div>
                    </div>
                `;
                settlementList.appendChild(el);
            });
        }
    }

    function toggleChartCategory(cat) { if(activeCategoryFilter === cat) { activeCategoryFilter = null; } else { activeCategoryFilter = cat; } renderChartPage(); }

    function renderChartPage() { 
        updateBudgetSummary(); 
        const l=document.getElementById('payer-breakdown-list'); l.innerHTML=''; 
        
        const isPaymentMode = currentChartMode === 'payment';
        // Select data source based on mode
        const breakdownData = isPaymentMode ? window.payerBreakdown : window.consumptionBreakdown;
        
        const labels=Object.keys(breakdownData).filter(k => breakdownData[k] > 0), data=labels.map(k => breakdownData[k]);

        const baseCurr = tripData.baseCurrency || 'JPY';
        const baseSymbol = CURRENCY_SYMBOLS[baseCurr] || baseCurr;
        const rate = tripData.exchangeRate || 0.215;
        
        const ctx=document.getElementById('expenseChart'); 
        if(myChart)myChart.destroy(); 
        const bgColors = labels.map(name => { const idx = tripData.travelers.indexOf(name); return idx >= 0 ? generateThemePalette(tripData.themeColor, idx, tripData.travelers.length) : '#ccc'; });
        myChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:bgColors,borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}}); 
        
        if(labels.length===0){l.innerHTML='<p class="text-center text-gray-400 text-sm py-4">å°šç„¡æ¶ˆè²»</p>';}else{
            labels.forEach((n,i)=>{
                const amt=data[i], pct=Math.round((amt/data.reduce((a,b)=>a+b,0))*100); 
                const twd = Math.round(amt * rate);
                let displayAmt = `${baseSymbol} ${amt.toLocaleString()}`;
                const modeLabel = isPaymentMode ? "å·²æ”¯ä»˜" : "å·²æ¶ˆè²»";
                // æ ¸å¿ƒï¼šåœ¨ breakdown list item è† å›Šä¸Šä¹ŸåŠ å…¥å½ˆç°§æ•ˆæœ
                l.innerHTML+=`<div class="flex justify-between items-center border-b border-gray-50 pb-4 last:border-0 transition-all duration-300 hover:bg-gray-50 p-2 -mx-2 rounded"><div class="flex items-center gap-3"><div class="avatar-circle" style="width:32px;height:32px;font-size:12px;background-color:${bgColors[i]};border-color:${bgColors[i]}">${n.substring(0,1)}</div><div><div class="text-base font-medium text-ink">${n}</div><div class="text-[10px] text-gray-400">${modeLabel}</div></div></div><div class="text-right"><div class="text-lg font-bold text-[var(--theme-color)]">${displayAmt}</div><div class="text-xs text-gray-400 font-bold">â‰ˆ NT$ ${twd.toLocaleString()} (${pct}%)</div></div></div>`;
            });
        } 

        const catCtx = document.getElementById('categoryChart');
        if(categoryChart) categoryChart.destroy();
        let categories = ['é£Ÿ','è¡£','ä½','è¡Œ','è‚²','æ¨‚','è³¼','é›œ'];
        const legendContainer = document.getElementById('categoryChartLegend');
        legendContainer.innerHTML = '';
        categories.forEach(cat => {
            const color = CAT_COLORS[cat] || '#ccc';
            const icon = getCategoryIcon(cat);
            const item = document.createElement('div');
            item.id = `legend-${cat}`;
            if (activeCategoryFilter === null) { item.className = 'legend-pill'; } else if (activeCategoryFilter === cat) { item.className = 'legend-pill active'; } else { item.className = 'legend-pill inactive'; }
            item.onclick = () => toggleChartCategory(cat);
            item.innerHTML = `<span class="legend-dot" style="background-color:${color}"></span>${icon} ${cat}`;
            legendContainer.appendChild(item);
        });
        
        // Bar Chart Data uses consumption breakdown (personCategoryBreakdown)
        const barDatasets = categories.map(cat => {
            const isHidden = activeCategoryFilter !== null && activeCategoryFilter !== cat;
            return {
                label: cat,
                data: tripData.travelers.map(person => window.personCategoryBreakdown[person] ? window.personCategoryBreakdown[person][cat] || 0 : 0),
                backgroundColor: CAT_COLORS[cat] || '#ccc',
                stack: 'Stack 0', hidden: isHidden 
            };
        });

        categoryChart = new Chart(catCtx, {
            type: 'bar',
            data: { labels: tripData.travelers, datasets: barDatasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += baseSymbol + context.parsed.y.toLocaleString(); } return label; } } } }
            }
        });
        
        const detailList = document.getElementById('category-detail-list');
        detailList.innerHTML = '';
        
        // é¸æ“‡è³‡æ–™ä¾†æºï¼šæ ¹æ“šæ¨¡å¼é¸æ“‡ Payment List æˆ– Consumption List
        const sourceDataList = isPaymentMode ? window.categoryListPayment : window.categoryListConsumption;

        categories.forEach(cat => {
            if (activeCategoryFilter !== null && activeCategoryFilter !== cat) return;
            const data = sourceDataList[cat]; // Retrieve correct data list
            if(data && data.total > 0) {
                const color = CAT_COLORS[cat];
                const icon = getCategoryIcon(cat);
                
                // Sort by amount descending
                data.items.sort((a,b) => b.amount - a.amount);
                
                const sectionTwd = Math.round(data.total * rate);
                let sectionTotalDisplay = `${baseSymbol}${data.total.toLocaleString()} <span class="text-xs text-gray-400 ml-1 font-sans">â‰ˆ NT$ ${sectionTwd.toLocaleString()}</span>`;
                let html = `<div class="border border-gray-100 rounded-xl overflow-hidden category-section" data-category="${cat}"><div class="bg-gray-50 p-3 flex justify-between items-center"><div class="flex items-center gap-2 font-bold text-ink"><span class="w-3 h-3 rounded-full" style="background:${color}"></span>${icon} ${cat}</div><div class="font-bold text-[var(--theme-color)]">${sectionTotalDisplay}</div></div><div class="divide-y divide-gray-50 bg-white">`;
                data.items.forEach(item => {
                    const itemTwd = Math.round(item.amount * rate);
                    let itemAmtDisplay = `${baseSymbol}${item.amount.toLocaleString()}`;
                    
                    // Detail Text Logic
                    let detailMeta = '';
                    
                    if (isPaymentMode) {
                        // Payment Mode Text
                        if (item.beneficiary === 'å‡æ”¤') {
                            detailMeta = `${item.date} â€¢ ${item.payer} ä»˜æ¬¾ â®• å…¨å“¡å‡æ”¤`;
                        } else if(item.payer !== item.beneficiary) {
                            detailMeta = `${item.date} â€¢ ${item.payer} ä»˜æ¬¾ â®• ${item.beneficiary}`;
                        } else {
                            detailMeta = `${item.date} â€¢ ${item.payer} ä»˜æ¬¾ (è‡ªç”¨)`;
                        }
                    } else {
                        // Consumption Mode Text
                        if (item.isShared) {
                             detailMeta = `${item.date} â€¢ ${item.beneficiary} åˆ†æ”¤ (ç”± ${item.payer} ä»£å¢Š)`;
                        } else if(item.payer !== item.beneficiary) {
                            detailMeta = `${item.date} â€¢ ${item.beneficiary} æ¶ˆè²» (ç”± ${item.payer} ä»˜)`;
                        } else {
                            detailMeta = `${item.date} â€¢ ${item.beneficiary} æ¶ˆè²»`;
                        }
                    }
                    // æ ¸å¿ƒï¼šåœ¨ detail item ä¸Šä¹ŸåŠ å…¥å¹³æ»‘è½‰å ´
                    html += `<div class="p-3 flex justify-between text-sm hover:bg-gray-50 transition duration-300"><div><div class="text-gray-800 font-medium">${item.name}</div>${item.detail ? `<div class="text-xs text-[var(--theme-color)] mt-1 block">${item.detail}</div>` : ''}<div class="text-xs text-gray-400 mt-1">${detailMeta}</div></div><div class="text-right"><div class="text-gray-600 font-serif font-bold">${itemAmtDisplay}</div><div class="text-[10px] text-gray-400">â‰ˆ NT$ ${itemTwd.toLocaleString()}</div></div></div>`;
                });
                html += `</div></div>`;
                detailList.innerHTML += html;
            }
        });
    }

    function copyAddress(text) {
        if(!text) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast(`å·²è¤‡è£½åœ°å€ï¼š${text}`); // ä½¿ç”¨ showToast
        }).catch(err => { console.error('Copy failed', err); window.alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'); });
    }

    // é€šç”¨è¤‡è£½æ–‡å­—å‡½å¼
    function copyText(text, label) {
        if(!text) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast(`å·²è¤‡è£½${label}ï¼š${text}`);
        }).catch(err => { console.error('Copy failed', err); window.alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'); });
    }
    
    // --- æ¢å¾© PDF åŒ¯å‡ºå‡½å¼ ---
    // (éœ€è¦å¤–éƒ¨å‡½å¼åº« html2canvas å’Œ jspdf.umd.min.js)
    async function exportAllPdf() {
        if (!currentProjectId) {
            showToast("è«‹å…ˆé¸æ“‡ä¸€å€‹æ—…ç¨‹ã€‚");
            return;
        }

        const tempContainer = document.getElementById('pdf-temp-container');
        const originalContent = document.getElementById('screen-itinerary').cloneNode(true);
        const headerContent = originalContent.querySelector('#header-content').cloneNode(true);

        // ç§»é™¤ä¸å¿…è¦çš„å…ƒç´ ä»¥å„ªåŒ– PDF å…§å®¹
        const excludedSelectors = [
            '.sticky-header', 
            '.float-btn', 
            '#template-actions', 
            '#quick-add-act-btn', 
            '.drag-handle-btn',
            '.expense-panel-responsive',
            '.card-actions', 
            '.timeline-dot',
            // éš±è—è¡Œç¨‹ç·¨è¼¯å™¨ï¼Œåªä¿ç•™å…§å®¹
            '.edit-mode' 
        ];

        // ç§»é™¤æ‰€æœ‰æ§åˆ¶é …
        excludedSelectors.forEach(selector => {
            originalContent.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        // é¡¯ç¤ºæ‰€æœ‰åŸæœ¬è¢«éš±è—çš„ view-mode å…§å®¹ï¼ˆç†è«–ä¸Š edit-mode å·²ç¶“è¢«ç§»é™¤äº†ï¼‰
        originalContent.querySelectorAll('.view-mode.hidden').forEach(el => el.classList.remove('hidden'));


        // æå–ä¸¦æ ¼å¼åŒ–æ´»å‹•åˆ—è¡¨
        let timelineHtml = `<div class="pdf-timeline-container space-y-6">`;
        const activities = tripData.days[`Day ${currentDay}`]?.activities || [];

        activities.forEach((act, idx) => {
            const expensePanel = `<div class="text-xs mt-2 text-gray-600 font-sans">ğŸ’° è²»ç”¨: ${act.costType} / ${act.currency} ${act.splits.reduce((sum, s) => sum + (s.amount || 0), 0).toLocaleString()}</div>`;
            
            timelineHtml += `
                <div class="relative pl-6">
                    <div class="absolute w-1 h-full bg-gray-200 left-0 top-0"></div>
                    <div class="absolute left-[-4px] top-[4px] w-3 h-3 bg-white border border-[var(--theme-color)] rounded-full z-10"></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-xs font-sans text-gray-400 tracking-widest">${act.time}</span>
                            <span class="text-[10px] text-[var(--theme-color)] font-bold tracking-[0.2em] uppercase font-sans bg-[var(--theme-color)]/5 px-2 py-0.5 rounded">${act.label||'VISIT'}</span>
                        </div>
                        <h3 class="text-lg font-serif font-bold text-ink leading-tight">${act.icon} ${act.location}</h3>
                        ${act.address ? `<div class="text-xs text-gray-500 mt-1">ğŸ“® ${act.address}</div>` : ''}
                        ${act.desc ? `<div class="text-sm text-gray-700 mt-2 whitespace-pre-wrap">${act.desc}</div>` : ''}
                        ${expensePanel}
                    </div>
                </div>
            `;
        });

        timelineHtml += `</div>`;

        // æ•´ç† PDF å…§å®¹
        tempContainer.innerHTML = `
            <div class="p-8">
                <h1 class="text-3xl font-bold text-center text-[var(--theme-color)] mb-1 font-serif">${tripData.theme}</h1>
                <p class="text-center text-sm text-gray-500 mb-8 font-sans">${new Date(tripData.startDate).toLocaleDateString()} - ${new Date(tripData.endDate).toLocaleDateString()}</p>
                <h2 class="text-2xl font-bold text-ink mb-4 font-serif">Day ${currentDay} (${tripData.days[`Day ${currentDay}`].date})</h2>
                ${timelineHtml}
            </div>
        `;

        tempContainer.style.display = 'block';

        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const margin = 10;
        const width = 190;
        const totalHeight = pdf.internal.pageSize.getHeight();
        let y = margin;

        const captureElement = tempContainer.firstElementChild;
        
        // ä½¿ç”¨ html2canvas æ“·å–å…§å®¹
        const canvas = await html2canvas(captureElement, {
            scale: 2,
            logging: false,
            useCORS: true
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const imgHeight = (canvas.height * width) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', margin, y, width, imgHeight);
        heightLeft -= totalHeight - margin;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight + margin;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', margin, position, width, imgHeight);
            heightLeft -= totalHeight;
        }

        pdf.save(`${tripData.theme}_Day${currentDay}.pdf`);

        // æ¸…ç†
        tempContainer.style.display = 'none';
        tempContainer.innerHTML = '';
        showToast("PDF åŒ¯å‡ºå®Œæˆï¼");
    }
    // --- çµæŸ PDF åŒ¯å‡ºå‡½å¼ ---
    
    // --- Excel åŒ¯å…¥/è²»ç”¨é‚è¼¯ (æ–°å¢ Excel åŒ¯å…¥) ---
    
    /**
     * Helper to read Excel file into a buffer.
     */
    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                resolve(data);
            };
            reader.onerror = (e) => reject(e);
            reader.readAsArrayBuffer(file);
        });
    }

    /**
     * Main function for Excel Import.
     */
    async function importActivitiesFromExcel(event) {
        if (!currentProjectId) {
            showToast("è«‹å…ˆé¸æ“‡ä¸€å€‹æ—…ç¨‹ã€‚");
            return;
        }

        const file = event.target.files[0];
        if (!file) return;

        try {
            const data = await readExcelFile(file);
            const workbook = XLSX.read(data, { type: 'array' });
            
            let itineraryData = [];
            let expensesData = [];
            let listsData = {};

            // Helper to extract sheet data
            const getSheetData = (sheetName) => {
                const sheet = workbook.Sheets[sheetName];
                if (sheet) {
                    // Convert sheet to array of arrays (raw data)
                    return XLSX.utils.sheet_to_json(sheet, { header: 1 });
                }
                return null;
            };

            // 1. è™•ç†ã€Œè¡Œç¨‹ã€å·¥ä½œè¡¨
            const itinerarySheetData = getSheetData('è¡Œç¨‹');
            if (itinerarySheetData && itinerarySheetData.length > 0) {
                // ASSUME: Meta data is in the first row, Activity data headers are dynamic
                
                // NEW: Parse Meta Data from the first row of "è¡Œç¨‹" sheet (Row 0)
                const metaRow = itinerarySheetData[0];
                if (metaRow && String(metaRow[0]).startsWith('æ—…è¡Œåç¨±')) {
                    const importedMeta = {
                        theme: String(metaRow[0]).split(': ')[1]?.trim() || tripData.theme,
                        travelers: String(metaRow[1]).split(': ')[1]?.trim().split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t) || tripData.travelers,
                        baseCurrency: String(metaRow[2]).split(': ')[1]?.trim() || tripData.baseCurrency,
                        exchangeRate: parseFloat(String(metaRow[3]).split(': ')[1]?.trim()) || tripData.exchangeRate,
                    };

                    if (window.confirm("åµæ¸¬åˆ°æ–°çš„æ—…è¡Œè¨­å®šï¼Œæ˜¯å¦è¦è¦†è“‹ç•¶å‰è¨­å®šï¼ˆåç¨±ã€åŒ¯ç‡ã€æ—…ä¼´ï¼‰ï¼Ÿ")) {
                        Object.assign(tripData, importedMeta);
                        // We rely on activity import/updateDateRange later to set start/end date
                    }
                }
                
                // Find Activity Header Row (Row containing "æ™‚é–“", "åœ°é»")
                let headerRowIndex = itinerarySheetData.findIndex(row => row.includes('æ™‚é–“') && row.includes('åœ°é»'));
                
                if (headerRowIndex !== -1) {
                    itineraryData = itinerarySheetData.slice(headerRowIndex + 1);
                    const headers = itinerarySheetData[headerRowIndex];
                    
                    if (window.confirm("åµæ¸¬åˆ°æ–°çš„è¡Œç¨‹æ´»å‹•ï¼Œæ˜¯å¦è¦æ›¿æ›ç•¶å‰æ—…è¡Œæ‰€æœ‰ Day çš„è¡Œç¨‹æ´»å‹•ï¼Ÿ")) {
                        await parseAndImportItinerary(itineraryData, headers); // Overwrite mode (default)
                    } else if (window.confirm("æ˜¯å¦è¦å°‡é€™äº›è¡Œç¨‹æ´»å‹•ã€è¿½åŠ ã€‘åˆ°ç•¶å‰è¡Œç¨‹çš„æ´»å‹•åˆ—è¡¨æœ«å°¾ï¼Ÿ")) {
                        await parseAndImportItinerary(itineraryData, headers, true); // Append mode
                    }
                } else {
                     showToast("è­¦å‘Š: ã€Œè¡Œç¨‹ã€å·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°æ´»å‹•æ¨™é ­ã€‚");
                }
            } else {
                 showToast("è­¦å‘Š: Excel æª”æ¡ˆä¸­æœªæ‰¾åˆ°æˆ–ç„¡æ³•è§£æã€Œè¡Œç¨‹ã€å·¥ä½œè¡¨ã€‚");
            }

            // 2. è™•ç†ã€Œè²»ç”¨ã€å·¥ä½œè¡¨
            const expensesSheetData = getSheetData('è²»ç”¨');
            if (expensesSheetData && expensesSheetData.length > 0) {
                // Find Header Row
                let headerRowIndex = expensesSheetData.findIndex(row => row.includes('é …ç›®åç¨±') && row.includes('é‡‘é¡'));
                
                if (headerRowIndex !== -1) {
                    const expensesRows = expensesSheetData.slice(headerRowIndex + 1);
                    const headers = expensesSheetData[headerRowIndex];
                    
                    if (window.confirm("åµæ¸¬åˆ°æ–°çš„è²»ç”¨åˆ—è¡¨ï¼Œæ˜¯å¦è¦ã€è¦†è“‹ã€‘ç•¶å‰æ‰€æœ‰è²»ç”¨è¨˜éŒ„ï¼Ÿ")) {
                        parseAndImportExpenses(expensesRows, headers, false);
                    } else if (window.confirm("æ˜¯å¦è¦å°‡é€™äº›è²»ç”¨ã€è¿½åŠ ã€‘åˆ°ç•¶å‰è²»ç”¨åˆ—è¡¨æœ«å°¾ï¼Ÿ")) {
                        parseAndImportExpenses(expensesRows, headers, true);
                    }
                }
            }
            
            // 3. è™•ç†ã€Œæ¸…å–®ã€å·¥ä½œè¡¨ 
            const listsSheetData = getSheetData('æ¸…å–®');
             if (listsSheetData && listsSheetData.length > 0) {
                 if (window.confirm("åµæ¸¬åˆ°æ–°çš„æ¸…å–®è³‡æ–™ï¼Œæ˜¯å¦è¦ã€è¦†è“‹ã€‘ç›®å‰çš„è¡Œææº–å‚™å’Œè³¼ç‰©é¡˜æœ›æ¸…å–®ï¼Ÿ")) {
                     parseAndImportLists(listsSheetData);
                 }
             }
             
            // Re-apply theme and re-render everything based on potentially new tripData
            updateDateRange(); // Recalculate days based on metadata
            applyTheme();
            renderHeader(); 
            renderDayTabs();
            renderTimeline(true);
            renderExpensesList();
            renderListsPage();
            updateBudgetSummary();
            
            showToast(`Excel åŒ¯å…¥å®Œæˆï¼`);

        } catch (error) {
            console.error("Excel åŒ¯å…¥å¤±æ•—:", error);
            showToast(`Excel åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚(${error.message})`);
        } finally {
            // æ¸…é™¤æª”æ¡ˆ input çš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½è§¸ç™¼ onchange äº‹ä»¶
            event.target.value = null; 
        }
    }
    
    /**
     * Parses itinerary data from Excel rows and imports/appends it.
     */
    async function parseAndImportItinerary(rows, headers, appendMode = false) {
        const defaultTraveler = tripData.travelers[0] || 'è‡ªå·±';
        const defaultCurrency = tripData.baseCurrency || 'JPY';
        
        let newActivitiesByDay = {}; // { dayIndex: [activity, ...] }
        
        const keyMap = {
            'Day': 'day', 'æ—¥æœŸ': 'date', 'æ™‚é–“': 'time', 'åœ–ç¤º': 'icon', 'æ¨™ç±¤': 'label',
            'åœ°é»': 'location', 'åœ°å€': 'address', 'ä¿¡ç®±': 'email', 'å‚™è¨»(æ”¯æ´æ›è¡Œ)': 'desc',
            'é¡åˆ¥': 'costType', 'è²»ç”¨ç´°é …': 'expenseDetail', 'å¹£åˆ¥': 'currency',
            'åˆ†å¸³è©³æƒ… (JSON æ ¼å¼)': 'splitsJson'
        };

        rows.forEach(row => {
            let act = {};
            let dayIndex = '1';

            headers.forEach((header, index) => {
                const key = keyMap[header.trim()];
                const value = row[index] !== undefined ? String(row[index]).trim() : '';

                if (key === 'day') {
                    dayIndex = String(value);
                } else if (key && key !== 'date') { // Date is only for reference here, actual date is pulled from tripData.days later
                    act[key] = value;
                }
            });

            // Reconstruct splits
            act.splits = [];
            const splitsJson = act.splitsJson; 
            delete act.splitsJson; // Clean up the temp field

            if (splitsJson) {
                try {
                    // Internal JSON string uses \\n for new lines
                    const parsedSplits = JSON.parse(splitsJson.replace(/\\n/g, '\n'));
                    if (Array.isArray(parsedSplits)) {
                         act.splits = parsedSplits.map(s => ({
                            id: uuidv4(), 
                            beneficiary: s.beneficiary || defaultTraveler,
                            payer: s.payer || defaultTraveler,
                            amount: parseInt(s.amount) || 0,
                            currency: s.currency || act.currency || defaultCurrency
                        }));
                    }
                } catch (e) {
                    console.error("Splits JSON parsing failed:", e);
                    act.splits = [{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: act.currency || defaultCurrency }];
                }
            } else {
                 act.splits = [{ id: uuidv4(), beneficiary: defaultTraveler, payer: defaultTraveler, amount: 0, currency: act.currency || defaultCurrency }];
            }

            // Ensure mandatory fields
            act.icon = act.icon || 'ğŸ“';
            act.time = act.time || '12:00';
            act.costType = act.costType || 'é›œ';

            if (!newActivitiesByDay[dayIndex]) {
                newActivitiesByDay[dayIndex] = [];
            }
            newActivitiesByDay[dayIndex].push(act);
        });

        // Apply imported activities to tripData
        Object.entries(tripData.days).forEach(([dayKey, dayObj]) => {
            const dayIndex = dayKey.replace('Day ', '');
            const newActs = newActivitiesByDay[dayIndex];
            
            // Fix: Check if newActs is defined. If we are in overwrite mode and Excel provides no data for a day, clear it.
            if (!appendMode && newActs === undefined) {
                dayObj.activities = []; // Overwrite with empty array if no data is provided for this day in Excel
            } else if (newActs && newActs.length > 0) {
                
                if (appendMode) {
                    dayObj.activities.push(...newActs);
                    
                    // Sort the entire day's activities after appending
                    const dayNum = parseInt(dayIndex);
                    // Temporarily set currentDay to sort the activities for that day, then immediately switch back.
                    const originalDay = currentDay; 
                    currentDay = dayNum; 
                    sortCurrentDayActivities();
                    currentDay = originalDay;
                    
                } else {
                    // Overwrite mode
                    dayObj.activities = newActs;
                }
            } else if (!appendMode && newActs?.length === 0) {
                 // Explicitly provided empty array in Excel, so clear the activities.
                dayObj.activities = [];
            }
        });
    }
    
    /**
     * Parses expenses data from Excel rows and imports/appends it.
     */
    function parseAndImportExpenses(rows, headers, appendMode) {
        let newExpenses = [];
        
        const keyMap = {
            'æ—¥æœŸ': 'date', 'é¡åˆ¥': 'category', 'é …ç›®åç¨±': 'name', 'ç´°é …å‚™è¨»': 'detail', 
            'ä»˜æ¬¾äºº(èª°å‡ºéŒ¢)': 'payer', 'å—ç›Šäºº(æ­¸å±¬èª°)': 'beneficiary', 'é‡‘é¡': 'amount', 
            'å¹£åˆ¥': 'currency'
        };

        // Skip potential meta rows, start looking for data after headers
        let dataStart = rows.findIndex(row => row[0]?.trim() === 'æ—¥æœŸ');
        if (dataStart === -1) return; 

        const dataRows = rows.slice(dataStart + 1);

        dataRows.forEach(row => {
            let exp = {};
            let isValid = true;
            
            headers.forEach((header, index) => {
                const key = keyMap[header.trim()];
                const value = row[index] !== undefined ? String(row[index]).trim() : '';

                if (key === 'amount') {
                    // Clean value before parsing int
                    const cleanedValue = value.replace(/[$,Â¥â‚©à¸¿â‚¬]/g, '').replace(/,/g, '');
                    exp[key] = parseInt(cleanedValue) || 0;
                    if (exp[key] <= 0) isValid = false;
                } else if (key) {
                    exp[key] = value;
                }
            });

            // Ensure mandatory fields are set
            exp.currency = exp.currency || tripData.baseCurrency;
            exp.category = exp.category || 'é›œ';
            exp.payer = exp.payer || tripData.travelers[0] || 'è‡ªå·±';
            exp.beneficiary = exp.beneficiary || exp.payer;
            exp.name = exp.name || 'æœªå‘½åè²»ç”¨';

            if (isValid) {
                newExpenses.push(exp);
            }
        });

        if (appendMode) {
            tripData.expenses.push(...newExpenses);
        } else {
            tripData.expenses = newExpenses;
        }
    }
    
    /**
     * Parses list data from Excel rows and imports/appends it.
     */
    function parseAndImportLists(rows) {
        // Fix: Explicitly clear before populating in overwrite mode (which is always for lists now)
        tripData.checklist = [];
        tripData.shoppingList = [];
        let currentList = null;

        rows.forEach(row => {
            const firstCell = String(row[0] || '').trim();
            
            if (firstCell === 'è¡Œææº–å‚™æ¸…å–®') {
                currentList = 'checklist';
                return;
            } else if (firstCell === 'è³¼ç‰©é¡˜æœ›æ¸…å–®') {
                currentList = 'shoppingList';
                return;
            } else if (firstCell === 'é …ç›®') {
                // Skip header row
                return;
            }

            if (currentList && firstCell) {
                const item = firstCell;
                // Check if the second column value is "æ˜¯" (Yes) or boolean true
                const checkedValue = String(row[1] || '').trim().toLowerCase();
                const checked = checkedValue === 'æ˜¯' || checkedValue === 'true';
                
                if (currentList === 'checklist') {
                    tripData.checklist.push({ text: item, checked: checked });
                } else if (currentList === 'shoppingList') {
                    tripData.shoppingList.push({ text: item, checked: checked });
                }
            }
        });
    }

    // --- END Excel åŒ¯å…¥/è²»ç”¨é‚è¼¯ ---


    // --- Excel åŒ¯å‡ºé‚è¼¯ (ä¸è®Š) ---

    function prepareItinerarySheetData() {
        const baseCurr = tripData.baseCurrency || 'JPY';
        const rate = tripData.exchangeRate || 0.0;
        const data = [];
        
        // 1. å¯«å…¥å…ƒæ•¸æ“š
        data.push([`æ—…è¡Œåç¨±: ${tripData.theme}`, `æ—…ä¼´: ${tripData.travelers.join(', ')}`, `å¤–å¹£: ${baseCurr}`, `åŒ¯ç‡(å¤–å¹£æ›å°å¹£): ${rate}`]);
        data.push([]); // ç©ºè¡Œåˆ†éš”
        
        // 2. å¯«å…¥æ´»å‹•æ•¸æ“šæ¨™é ­
        const headers = [
            "Day", "æ—¥æœŸ", "æ™‚é–“", "åœ–ç¤º", "æ¨™ç±¤", "åœ°é»", "åœ°å€", "ä¿¡ç®±", "å‚™è¨»(æ”¯æ´æ›è¡Œ)", 
            "é¡åˆ¥", "è²»ç”¨ç´°é …", "å¹£åˆ¥", "ç¸½é‡‘é¡", "ç¸½å°å¹£(ç´„)", "åˆ†å¸³è©³æƒ… (JSON æ ¼å¼)",
            "-------------------", "åŒ¯å…¥æ™‚è«‹ä½¿ç”¨CSVåŠŸèƒ½", "-------------------"
        ];
        data.push(headers);
        
        // 3. å¯«å…¥æ´»å‹•æ•¸æ“š
        Object.entries(tripData.days).forEach(([dayKey, dayData]) => {
            const dayIndex = dayKey.replace('Day ', '');
            dayData.activities.forEach((act) => {
                
                // è¨ˆç®—ç¸½é‡‘é¡
                const totalAmount = act.splits.reduce((sum, s) => sum + (s.amount || 0), 0);
                let twdAmount = 0;
                if (act.currency === 'TWD') { twdAmount = totalAmount; } 
                else { twdAmount = Math.round(totalAmount * rate); }

                // æº–å‚™åˆ†å¸³è©³æƒ… JSON å­—ä¸² (ç‚ºäº†åŒ¯å…¥ä¿ç•™çµæ§‹)
                const splitsJson = JSON.stringify(act.splits || []).replace(/\n/g, '\\n'); // å…§éƒ¨æ›è¡Œè½‰ç¾©
                
                const row = [
                    dayIndex,
                    dayData.date,
                    act.time,
                    act.icon,
                    act.label,
                    act.location,
                    act.address,
                    act.email,
                    act.desc,
                    act.costType,
                    act.expenseDetail,
                    act.currency,
                    totalAmount,
                    twdAmount,
                    splitsJson,
                    "", "", "" // ä½”ä½ç¬¦
                ];
                data.push(row);
            });
        });
        
        return data;
    }

    function prepareListsSheetData() {
        const data = [];

        // 1. è¡Œææº–å‚™æ¸…å–®
        data.push(["è¡Œææº–å‚™æ¸…å–®"]);
        data.push(["é …ç›®", "å·²å®Œæˆ"]);
        tripData.checklist.forEach(item => {
            data.push([item.text, item.checked ? "æ˜¯" : "å¦"]);
        });
        
        data.push([]); // ç©ºè¡Œåˆ†éš”
        data.push([]); 

        // 2. è³¼ç‰©é¡˜æœ›æ¸…å–®
        data.push(["è³¼ç‰©é¡˜æœ›æ¸…å–®"]);
        data.push(["é …ç›®", "å·²å®Œæˆ"]);
        tripData.shoppingList.forEach(item => {
            data.push([item.text, item.checked ? "æ˜¯" : "å¦"]);
        });
        
        return data;
    }

    function prepareExpensesSheetData() {
        const baseCurr = tripData.baseCurrency || 'JPY';
        const rate = tripData.exchangeRate || 0.0;
        const data = [];
        
        data.push([`å¤–å¹£: ${baseCurr}`, `åŒ¯ç‡(å¤–å¹£æ›å°å¹£): ${rate}`]);
        data.push([]);

        const headers = ["æ—¥æœŸ", "é¡åˆ¥", "é …ç›®åç¨±", "ç´°é …å‚™è¨»", "ä»˜æ¬¾äºº(èª°å‡ºéŒ¢)", "å—ç›Šäºº(æ­¸å±¬èª°)", "é‡‘é¡", "å¹£åˆ¥", "å°å¹£é‡‘é¡(ç´„)"];
        data.push(headers);
        
        tripData.expenses.forEach(exp => {
            const isTwd = exp.currency === 'TWD';
            let twd = 0;
            if(isTwd) twd = exp.amount;
            else twd = Math.round(exp.amount * rate);
            
            const row = [
                exp.date,
                exp.category,
                exp.name,
                exp.detail || '',
                exp.payer,
                exp.beneficiary || exp.payer,
                exp.amount,
                exp.currency,
                twd
            ];
            data.push(row);
        });
        
        return data;
    }
    
    function prepareStatisticsSheetData() {
        // Must ensure updateBudgetSummary has run to populate global variables
        updateBudgetSummary(); 

        const data = [];
        const baseCurr = tripData.baseCurrency || 'JPY';
        const rate = tripData.exchangeRate || 0.0;
        const categories = ['é£Ÿ','è¡£','ä½','è¡Œ','è‚²','æ¨‚','è³¼','é›œ'];
        const travelers = tripData.travelers;
        
        data.push([`å¤–å¹£: ${baseCurr}`, `åŒ¯ç‡(å¤–å¹£æ›å°å¹£): ${rate}`, `ç¸½èŠ±è²» (${baseCurr}): ${Object.values(window.payerBreakdown).reduce((a,b) => a+b, 0).toLocaleString()}`]);
        data.push([]);
        
        // 1. çµå¸³åˆ†å¸³å»ºè­°
        data.push(["--- çµå¸³åˆ†å¸³å»ºè­° (ä»¥æœ€å°‘äº¤æ˜“æ¬¡æ•¸å¹³å¸³) ---"]);
        data.push(["æ”¯ä»˜äºº (From)", "æ¥æ”¶äºº (To)", `é‡‘é¡ (${baseCurr})`, "å°å¹£é‡‘é¡ (ç´„)"]);
        if (window.calculatedSettlements && window.calculatedSettlements.length > 0) {
            window.calculatedSettlements.forEach(tx => {
                data.push([tx.from, tx.to, tx.amount, tx.twd]);
            });
        } else {
            data.push(["ğŸ‰ ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³"]);
        }
        
        data.push([]); 
        data.push([]); 
        
        // 2. äººå“¡èŠ±è²»æ˜ç´° (Consumption Mode for actual attribution)
        data.push(["--- äººå“¡èŠ±è²»æ˜ç´° (å¯¦éš›æ­¸å±¬æ¶ˆè²»é‡‘é¡, å–®ä½: " + baseCurr + ") ---"]);
        data.push(["æ—…ä¼´", "å¯¦éš›æ¶ˆè²»ç¸½é¡", "å¯¦éš›æ¶ˆè²»ç¸½é¡ (ç´„å°å¹£)", "ä»˜æ¬¾ç¸½é¡ (å·²ä»£å¢Š)"]);
        travelers.forEach(person => {
            const consumption = window.consumptionBreakdown[person] || 0;
            const payment = window.payerBreakdown[person] || 0;
            const diff = payment - consumption;
            const status = diff > 0 ? `æ‡‰æ”¶å› ${Math.round(diff).toLocaleString()}` : (diff < 0 ? `æ‡‰æ”¯å‡º ${Math.round(Math.abs(diff)).toLocaleString()}` : "å·²å¹³è¡¡");

            data.push([
                person, 
                consumption, 
                Math.round(consumption * rate),
                payment,
                status // æ·¨é¤˜é¡/ç‹€æ…‹
            ]);
        });

        data.push([]); 
        data.push([]); 
        
        // 3. æ¯äººå„é …é¡åˆ¥èŠ±è²» (Consumption Mode)
        data.push(["--- æ¯äººå„é …é¡åˆ¥èŠ±è²» (å¯¦éš›æ­¸å±¬æ¶ˆè²»é‡‘é¡, å–®ä½: " + baseCurr + ") ---"]);
        const catHeaders = ["æ—…ä¼´", ...categories, "ç¸½è¨ˆ"];
        data.push(catHeaders);
        
        travelers.forEach(person => {
            const row = [person];
            let personTotal = 0;
            categories.forEach(cat => {
                const amount = window.personCategoryBreakdown[person] ? (window.personCategoryBreakdown[person][cat] || 0) : 0;
                row.push(Math.round(amount)); // é¿å…å°æ•¸é»éå¤š
                personTotal += amount;
            });
            row.push(Math.round(personTotal));
            data.push(row);
        });

        return data;
    }


    /**
     * Replaces exportActivitiesToCsv. Exports all four data sections into a single Excel file.
     */
    function exportAllToExcel() {
        if (!currentProjectId) {
            showToast("è«‹å…ˆé¸æ“‡ä¸€å€‹æ—…ç¨‹ã€‚");
            return;
        }
        
        // 1. æº–å‚™å››å€‹ Sheet çš„æ•¸æ“š
        const itineraryData = prepareItinerarySheetData();
        const listsData = prepareListsSheetData();
        const expensesData = prepareExpensesSheetData();
        const statisticsData = prepareStatisticsSheetData();
        
        // 2. å‰µå»º Workbook å’Œ Sheets
        const workbook = XLSX.utils.book_new();
        
        const itinerarySheet = XLSX.utils.aoa_to_sheet(itineraryData);
        XLSX.utils.book_append_sheet(workbook, itinerarySheet, "è¡Œç¨‹");
        
        const listsSheet = XLSX.utils.aoa_to_sheet(listsData);
        XLSX.utils.book_append_sheet(workbook, listsSheet, "æ¸…å–®");
        
        const expensesSheet = XLSX.utils.aoa_to_sheet(expensesData);
        XLSX.utils.book_append_sheet(workbook, expensesSheet, "è²»ç”¨");
        
        const statisticsSheet = XLSX.utils.aoa_to_sheet(statisticsData);
        XLSX.utils.book_append_sheet(workbook, statisticsSheet, "çµ±è¨ˆ");
        
        // 3. å‘½åæª”æ¡ˆ
        // æ—…ç¨‹åç¨±_è¥¿å…ƒå¹´æœˆæ—¥
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        // Clean trip name for filename
        const safeTheme = tripData.theme.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '').trim().substring(0, 50); 
        const filename = `${safeTheme || 'Travel'}_${dateStr}.xlsx`;
        
        // 4. åŒ¯å‡º Excel
        XLSX.writeFile(workbook, filename);
        
        showToast("Excel æª”æ¡ˆåŒ¯å‡ºå®Œæˆï¼");
    }

    // --- END Excel åŒ¯å‡ºé‚è¼¯ ---


    window.onload = init;
  </script>
</body>
</html>
